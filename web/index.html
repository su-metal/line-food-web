<!-- HOME:START -->
<header class="app-header">
  <div class="topbar">
    <a class="logo" href="./" aria-label="Mottaina Home">Mottaina</a>
    <button id="btn-locate" type="button" aria-label="現在地" title="現在地">📍</button>
    <a class="cart-link" href="./cart.html" aria-label="カート">
      <span class="cart-icon"></span>
      <span id="home-cart-count" class="badge">0</span>
    </a>
  </div>

  <div class="search-row">
    <input id="q" type="search" inputmode="search" autocomplete="off"
           placeholder="店名・商品・駅で検索" aria-label="検索" />
  </div>

  <nav class="filter-row">
    <!-- カテゴリ（既存構造に合わせて再掲） -->
    <div class="cat-row" id="category-row">
      <button type="button" class="cat-item is-active" data-cat="">
        <img src="./img/categories/all.png" alt="すべて" width="48" height="48" loading="lazy" />
        <span>すべて</span>
      </button>
      <button type="button" class="cat-item" data-cat="パン">
        <img src="./img/categories/bread.png" alt="パン" width="48" height="48" loading="lazy" />
        <span>パン</span>
      </button>
      <button type="button" class="cat-item" data-cat="惣菜">
        <img src="./img/categories/deli.png" alt="惣菜" width="48" height="48" loading="lazy" />
        <span>惣菜</span>
      </button>
      <button type="button" class="cat-item" data-cat="スイーツ">
        <img src="./img/categories/cake.png" alt="スイーツ" width="48" height="48" loading="lazy" />
        <span>スイーツ</span>
      </button>
    </div>

    <!-- 価格チップ + 並び替え -->
    <div class="price-sort-row">
      <div class="chip-group" role="group" aria-label="価格上限">
        <button type="button" class="chip is-active" data-price="">すべて</button>
        <button type="button" class="chip" data-price="<=300">〜¥300</button>
        <button type="button" class="chip" data-price="<=500">〜¥500</button>
        <button type="button" class="chip" data-price="<=800">〜¥800</button>
      </div>
      <div class="sort-group">
        <label for="sort-mode" class="sr-only">並び替え</label>
        <select id="sort-mode" aria-label="並び替え">
          <option value="near">近い順</option>
          <option value="cheap">安い順</option>
          <option value="deadline">締切が早い順</option>
          <option value="popular">人気順</option>
        </select>
      </div>
    </div>
  </nav>
</header>

<!-- ヒーロー（任意。画像が無ければ削除可） -->
<section id="home-hero" class="hero">
  <img src="./img/hero1.jpg" alt="" width="1280" height="500" loading="eager" />
  <img src="./img/hero2.jpg" alt="" width="1280" height="500" loading="lazy" />
  <img src="./img/hero3.jpg" alt="" width="1280" height="500" loading="lazy" />
</section>

<main class="home-main">
  <section class="section">
    <h3 class="section-title">近くのおすすめ</h3>
    <div id="nearby-row" class="card-row hscroll" aria-live="polite"></div>
  </section>

  <section class="section">
    <h3 class="section-title">最近見た</h3>
    <div id="recent-row" class="card-row hscroll" aria-live="polite"></div>
  </section>
</main>

<footer class="app-footer">
  <a id="btn-discover" href="./discover.html" class="button primary">地図で見る</a>
  <nav class="legal">
    <a href="./help.html">ヘルプ</a>
    <a href="./terms.html">利用規約</a>
    <a href="./privacy.html">プライバシー</a>
  </nav>
</footer>

<!-- ホームではカートバーは非表示だが、初期化の都合でDOMは置いておく -->
<div id="cart-bar" hidden aria-hidden="true"></div>

<!-- テンプレート（空にしない！） -->
<template id="shop-card-template">
  <article class="shop-card card-v3">
    <div class="card-head"></div>
    <div class="shop-info">
      <h4 class="store-name"></h4>
      <div class="chip-row">
        <span class="chip cat point"></span>
        <span class="chip distance status"></span>
        <span class="chip place"></span>
      </div>
    </div>
    <div class="card-body">
      <!-- JSで .product-summary を差し込む -->
    </div>
    <button class="fav-btn" type="button" aria-label="お気に入り"></button>
  </article>
</template>

<!-- スクリプトは1つに統合（旧module srcは削除） -->
<script type="module">
  import liff from "https://static.line-scdn.net/liff/edge/2/sdk.js";

  const bust = "v20250910a";

  // 動的import（キャッシュバスト）
  const [{ loadNearby }, { loadRecent }] = await Promise.all([
    import(`./js/nearby.js?b=${bust}`),
    import(`./js/recent.js?b=${bust}`),
  ]);
  const { initHomeCartCTA } = await import(`./js/cart-cta.js?b=${bust}`);
  // ヒーローを使う場合のみ有効化
  // await import(`./js/hero.js?b=${bust}`);
  // await import(`./js/home-hero.js?b=${bust}`);

  // フィルタ収集（既存JSと整合）
  const getFilters = () => {
    const cat = document.querySelector(".cat-item.is-active")?.dataset.cat || null;
    const priceData = document.querySelector(".chip-group .chip.is-active")?.dataset.price || null;
    const priceMax = priceData ? Number(priceData.replace("<=", "")) : null;
    const sort = localStorage.getItem("sortMode") || "near";
    return { category: cat, priceMax, sort };
  };

  // 初期描画
  await Promise.all([loadNearby(getFilters()), loadRecent(getFilters())]);

  // 外から再読込
  window.refreshLists = () => {
    const f = getFilters();
    return Promise.all([loadNearby(f), loadRecent(f)]);
  };

  // 価格チップの単一選択
  document.querySelectorAll(".chip-group .chip").forEach((el) => {
    el.addEventListener("click", () => {
      document.querySelectorAll(".chip-group .chip").forEach(c => c.classList.remove("is-active"));
      el.classList.add("is-active");
      refreshLists();
    });
  });

  // カテゴリ（単一選択。複数にしたい場合はロジック拡張）
  document.querySelectorAll("#category-row .cat-item").forEach((el) => {
    el.addEventListener("click", () => {
      document.querySelectorAll("#category-row .cat-item").forEach(c => c.classList.remove("is-active"));
      el.classList.add("is-active");
      refreshLists();
    });
  });

  // 並び替え保存＋反映
  const sortSel = document.getElementById("sort-mode");
  sortSel.value = localStorage.getItem("sortMode") || "near";
  sortSel.addEventListener("change", () => {
    localStorage.setItem("sortMode", sortSel.value);
    refreshLists();
  });

  // カートCTA（ホームはバッジ更新のみ）
  initHomeCartCTA({
    buttonSelector: "#cart-bar",
    countSelector: "#home-cart-count",
    totalSelector: "#home-cart-total",
    cartHref: "./cart.html",
  });
</script>
<!-- HOME:END -->
