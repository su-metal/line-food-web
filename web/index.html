<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>モッタイナ</title>

    <!-- Leaflet CSS & JS（Google Maps は読み込まない） -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- QR生成（予約完了時） -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

    <!-- アプリ内リアルタイムQRスキャン -->
    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>

    <style>
      /* ===== ベース ===== */
      :root {
        --appbar-h: 56px;
        --btn-radius: 12px;
        --brand: #6b1a16;
        --ink: #222;
        --muted: #666;
        --card: #fff;
        --bg: #f6f3ef;
        /* タブバーの被り対策: 実寸で上書き */
        --tabbar-h: 80px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: system-ui, -apple-system, "Segoe UI", Roboto,
          "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "メイリオ",
          Meiryo, sans-serif;
        background: var(--bg);
        color: var(--ink);
        margin: 16px;
        /* ヘッダー削除後：セーフエリア + 少しだけ余白 */
        padding-top: calc(env(safe-area-inset-top, 0) + 8px);
      }
      body,
      .page {
        padding-bottom: calc(var(--tabbar-h) + env(safe-area-inset-bottom, 0));
      }

      /* DEBUG: ホームのカードだけ "予約へ進む" を非表示にする */
      #page-home .btn-resv {
        display: none !important;
      }

      .muted {
        color: var(--muted);
        font-size: 0.9em;
      }

      .card {
        border: 1px solid #e5e2dd;
        border-radius: 12px;
        background: #fff;
        padding: 12px;
        margin: 10px 0;
      }

      .row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      button.primary {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
      }
      button.primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      button.secondary {
        background: #6c757d;
        color: #fff;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
      }
      button.secondary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      button.danger {
        background: #cc3333;
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
      }
      button.danger:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .badge {
        display: inline-block;
        margin-left: 8px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        vertical-align: middle;
      }
      .badge.soldout {
        background: #ddd;
        color: #555;
      }
      .badge.reserved {
        background: #2e7d32;
        color: #fff;
      }
      .badge.paid {
        background: #1e88e5;
        color: #fff;
      }

      /* 検索バー */
      .searchbar {
        background: #fff;
        border: 1px solid #e5e2dd;
        border-radius: 12px;
        padding: 8px 10px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .searchbar input {
        border: none;
        outline: none;
        width: 100%;
        font-size: 14px;
        background: transparent;
      }
      .searchbar svg {
        width: 18px;
        height: 18px;
      }

      /* 固定ヘッダー */
      .appbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: var(--appbar-h);
        display: flex;
        align-items: center;
        padding: 8px 12px calc(8px + env(safe-area-inset-right, 0))
          calc(12px + env(safe-area-inset-left, 0));
        background: #fff;
        border-bottom: 1px solid #e5e2dd;
        z-index: 1800;
      }

      /* タブバー */
      .tabbar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 2000;
        background: #fff;
        border-top: 1px solid #e5e2dd;
        display: flex;
        justify-content: space-around;
        padding: 8px calc(env(safe-area-inset-right, 0px))
          calc(8px + env(safe-area-inset-bottom, 0px))
          calc(env(safe-area-inset-left, 0px));
      }
      .tabbar button {
        background: none;
        border: none;
        padding: 6px 8px;
        color: #8a8278;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }
      .tabbar button.active {
        color: var(--brand);
        font-weight: 700;
      }
      .tabbar svg {
        width: 22px;
        height: 22px;
      }

      /* ページ切替 */
      .page {
        display: none;
      }
      .page.active {
        display: block;
      }

      /* ホーム：横スワイプカード */
      .carousel {
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: 80%;
        gap: 12px;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        padding: 6px 4px 18px;
      }
      .card-lg {
        position: relative;
        background: #000;
        color: #fff;
        border-radius: 16px;
        overflow: hidden;
        height: 220px;
        scroll-snap-align: start;
      }
      .card-lg img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        opacity: 0.95;
      }
      .card-lg .overlay {
        position: absolute;
        inset: auto 0 0 0;
        padding: 12px;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.65) 70%
        );
      }
      .card-lg .title {
        font-weight: 700;
        font-size: 16px;
        line-height: 1.2;
      }
      .card-lg .meta {
        display: flex;
        gap: 10px;
        font-size: 12px;
        opacity: 0.95;
        margin-top: 4px;
      }
      .card-lg .price {
        position: absolute;
        right: 10px;
        top: 10px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 10px;
        padding: 4px 8px;
        font-weight: 700;
      }

      /* 地図（初期は通常だが Discover では全画面） */
      #map {
        position: relative;
        z-index: 1;
        height: 58vh; /* Discoverの全画面時はCSSで上書き */
        margin-top: 12px;
        border: 1px solid #ccc;
        border-radius: 12px;
        min-height: 300px;
      }

      /* Discover = フルスクリーン地図モード */
      body.discover-full {
        overflow: hidden;
        padding-top: 0 !important;
      }
      body.discover-full .appbar {
        display: none !important;
      }

      #page-discover.fullmap {
        position: fixed;
        top: env(safe-area-inset-top, 0);
        left: 0;
        right: 0;
        bottom: calc(var(--tabbar-h) + env(safe-area-inset-bottom, 0));
        z-index: 1500;
        background: var(--bg);
        margin: 0;
        padding: 0;
      }
      #page-discover.fullmap #map {
        position: absolute;
        inset: 0;
        height: auto !important;
        border-radius: 0;
        border: none;
        margin: 0;
      }

      /* マップ上のUI（画像②風） */
      #page-discover {
        position: relative;
      }
      .map-ui {
        position: fixed;
        left: 12px;
        right: 12px;
        top: calc(env(safe-area-inset-top, 0) + 8px);
        z-index: 2100;
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 10px;
        pointer-events: none;
      }
      .map-ui > * {
        pointer-events: auto;
      } /* 子要素は操作可 */
      .fab {
        display: grid;
        place-items: center;
        width: 44px;
        height: 44px;
        border-radius: 999px;
        background: #fff;
        border: 1px solid #e5e2dd;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
        color: #6b1a16;
      }
      .map-search {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #fff;
        border: 1px solid #e5e2dd;
        border-radius: 999px;
        padding: 10px 12px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      }
      .map-search input {
        width: 100%;
        border: 0;
        outline: none;
        font-size: 14px;
        background: transparent;
      }
      .map-search input::placeholder {
        color: #8a8278;
        opacity: 1;
      }

      /* マップ用ボトムシート（カード再利用） */
      .map-sheet {
        position: fixed;
        left: 0;
        right: 0;
        bottom: calc(var(--tabbar-h) + 8px);
        padding: 0 12px;
        z-index: 2100;
        display: none;
      }
      .map-sheet.show {
        display: block;
      }
      .map-sheet .handle {
        width: 40px;
        height: 4px;
        border-radius: 2px;
        background: #d0ccc7;
        margin: 6px auto 8px;
      }
      .map-sheet .card-lg {
        width: 100%;
        height: 210px;
        border-radius: 16px;
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.18);
      }

      /* ボタン行 */
      .btn-row {
        display: flex;
        gap: 8px;
        margin: 8px 0 12px;
      }
      .btn-row > button {
        flex: 1;
        border-radius: var(--btn-radius) !important;
        min-width: 0;
      }

      /* モーダル／ライブスキャン */
      #modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
        z-index: 2147483646;
      }
      body.modal-open {
        overflow: hidden;
      }
      .live-scan {
        display: none;
        position: fixed;
        inset: 0;
        background: #000;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 2147483647 !important;
      }
      .live-scan.show {
        display: flex;
      }
      .live-scan video {
        max-width: 100%;
        max-height: 70vh;
        pointer-events: auto;
      }
      .live-scan .close-btn {
        margin-top: 12px;
        position: relative;
        z-index: 2147483647;
      }
      body.modal-open #map,
      body.modal-open .leaflet-container,
      body.live-scan-open #map,
      body.live-scan-open .leaflet-container {
        pointer-events: none !important;
      }
      /* ===== 店舗ページ ===== */
      #page-shop {
        padding-bottom: calc(var(--tabbar-h) + 72px);
      }

      .shop-hero {
        position: relative;
        height: 220px;
        border-radius: 12px;
        overflow: hidden;
        background: #eee;
      }
      .shop-hero img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .shop-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 12px 0 8px;
      }
      .shop-title h1 {
        font-size: 20px;
        margin: 0;
      }
      .heart {
        background: #fff;
        border: 1px solid #e5e2dd;
        width: 40px;
        height: 40px;
        border-radius: 999px;
        display: grid;
        place-items: center;
      }

      /* ハートのアニメ＆塗り替え */
      .heart {
        transition: transform 0.12s, color 0.2s, border-color 0.2s,
          background 0.2s;
      }
      .heart svg path {
        transition: fill 0.2s, stroke 0.2s;
      }

      /* ON のとき赤く塗る */
      .heart.active {
        color: #e11d48; /* currentColor を赤に */
        border-color: currentColor;
        background: #fff5f7; /* ほんのり背景(好みで削除OK) */
      }
      .heart.active svg path {
        fill: currentColor; /* 塗りを currentColor に */
        stroke: currentColor; /* 線も赤に（好みで残す/消す） */
      }

      /* 既存の .heart.active や .heart.active svg path の下あたりに */
      #btn-fav.active svg path {
        fill: currentColor !important;
        stroke: currentColor !important;
      }

      /* 店舗ページのハートを画面右上に固定配置 */
      .shop-mode #btn-fav {
        position: fixed;
        top: calc(env(safe-area-inset-top, 0) + 8px);
        right: 12px;
        z-index: 2200;
      }

      .meta-row {
        display: flex;
        gap: 10px;
        font-size: 13px;
        color: #666;
        flex-wrap: wrap;
      }

      .offer-list .offer {
        display: flex;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }
      .offer img {
        width: 88px;
        height: 88px;
        border-radius: 10px;
        object-fit: cover;
        background: #f2f2f2;
      }
      .offer .info {
        flex: 1;
        min-width: 0;
      }
      .offer .info .name {
        font-weight: 600;
      }
      .offer .info .time {
        color: #666;
        font-size: 12px;
      }

      .qty {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .qty button {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        border: 1px solid #e5e2dd;
        background: #fff;
      }

      .cart-bar {
        position: fixed;
        left: 12px;
        right: 12px;
        bottom: calc(var(--tabbar-h) + 8px);
        background: #fff;
        border: 1px solid #e5e2dd;
        border-radius: 12px;
        padding: 10px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.15);
        z-index: 2100;
      }
      .cart-bar .btn {
        background: #28a745;
        color: #fff;
        border: none;
        padding: 10px 14px;
        border-radius: 10px;
      }

      .section {
        margin: 14px 0;
      }
      .contact a {
        color: var(--brand);
        text-decoration: none;
      }

      /* モバイル: 正方形寄り */
      /* モバイル: 3:2 */
      #shop-map {
        width: 100%;
        aspect-ratio: 3 / 2;
        height: auto;
        min-height: 220px;
        border-radius: 12px;
        border: 1px solid #e5e2dd;
        overflow: hidden;
        max-width: 720px;
        margin: 0 auto;
      }

      /* 店舗ページのミニマップは固定表示（操作不可） */
      #shop-map .leaflet-container {
        pointer-events: none !important; /* クリック/ドラッグ/ホイール等を遮断 */
        touch-action: none; /* モバイルのピンチ/ダブルタップを遮断 */
      }
      /* 念のためコントロール類も非表示（ズームUIなど） */
      #shop-map .leaflet-control-container {
        display: none !important;
      }

      /* タブレット */
      @media (min-width: 768px) {
        #shop-map {
          aspect-ratio: 4 / 3;
          min-height: 260px;
          max-width: 820px;
        }
      }

      /* デスクトップ */
      @media (min-width: 1024px) {
        #shop-map {
          aspect-ratio: 16 / 9;
          min-height: 320px;
          max-width: 960px;
        }
      }

      /* ホーム上部に置いた検索バーの余白 */
      .home-search {
        margin: 8px 0 12px;
      }

      /* 店舗ページではホーム用検索を隠す */
      .shop-mode .home-search {
        display: none !important;
      }

      /* --- 店舗ページでは冒頭の共通UIを隠す --- */
      .shop-mode h1,
      .shop-mode #friendStatus,
      .shop-mode #me,
      .shop-mode #notice,
      .shop-mode .top-utilities {
        display: none !important;
      }

      /* 例1: 例外を追加して店名だけは表示 */
      .shop-mode #shop-name {
        display: block !important;
      }

      /* 例2: そもそも h1 を隠さない（行を削除/コメントアウト） */
      /* .shop-mode h1 { display: none !important; } */

      /* クリックしやすく（見た目変更なし） */
      .card-lg {
        cursor: pointer;
      }
      .carousel,
      .card-lg {
        pointer-events: auto;
      }

      /* 追加: ホーム用ヘッダー行（H1 + カートアイコン） */
      .home-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 0 0 8px;
      }

      /* ホームの検索窓を横いっぱいに広げる */
      .home-header {
        gap: 8px;
      } /* 好みで。なくてもOK */
      .home-header .home-search {
        flex: 1; /* 余白をすべて取る */
        min-width: 0; /* はみ出し防止 */
        margin: 0 8px 0 0; /* カートとの隙間 */
      }
      .home-header .home-search input {
        width: 100%;
      }
      .home-header .icon-btn {
        flex: 0 0 auto;
      } /* カートは固定幅のまま */

      .icon-btn {
        position: relative;
        width: 40px;
        height: 40px;
        border-radius: 999px;
        background: #fff;
        border: 1px solid #e5e2dd;
        display: grid;
        place-items: center;
        cursor: pointer;
      }
      .icon-btn svg {
        width: 22px;
        height: 22px;
      }

      /* バッジ（数量>0の時だけ表示） */
      .icon-btn .badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #e53935;
        color: #fff;
        font-size: 12px;
        line-height: 1;
        padding: 3px 6px;
        border-radius: 999px;
        display: none;
      }

      /* 店舗ページではホーム用ヘッダーを隠す */
      .shop-mode .home-header {
        display: none !important;
      }
      /* 強制上書き（競合対策） */
      .heart.active svg path {
        fill: currentColor !important;
        stroke: currentColor !important;
      }

      /* お気に入り一覧のカード（最小） */
      #page-fav #fav-list .fav-card {
        display: flex;
        align-items: center;
        gap: 10px;
        border: 1px solid #e5e2dd;
        background: #fff;
        border-radius: 12px;
        padding: 10px;
        margin: 10px 0;
      }
      #page-fav #fav-list .fav-card img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 10px;
        background: #f2f2f2;
      }
      #page-fav #fav-list .fav-card .name {
        font-weight: 700;
      }
      #page-fav #fav-list .fav-card .meta {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
      }

      /* お気に入り一覧のカード */
      .fav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        border: 1px solid #e5e2dd;
        border-radius: 12px;
        background: #fff;
        padding: 10px;
        margin: 8px 0;
      }
      .fav-item .thumb {
        width: 72px;
        height: 72px;
        border-radius: 10px;
        object-fit: cover;
        background: #f2f2f2;
      }
      .fav-item .info {
        flex: 1;
        min-width: 0;
      }
      .fav-item .title {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .fav-item .meta {
        color: #666;
        font-size: 12px;
        margin-top: 2px;
      }
      .fav-item .heart {
        width: 36px;
        height: 36px;
      } /* 右側の小さめハート */

      /* お気に入り解除後もカードは残す（薄く表示） */
      .fav-card.ghost {
        opacity: 0.6;
      }
      .fav-card .ghost-note {
        margin-left: 6px;
        font-size: 12px;
        color: #b3261e;
      }
      .fav-card.pending-remove {
        opacity: 0.6;
      }
    </style>
  </head>

  <body>
    <div class="home-header">
      <label class="map-search home-search">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
          <path
            d="M21 21l-3.8-3.8M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"
            stroke="#8a8278"
            stroke-width="1.6"
            stroke-linecap="round"
          />
        </svg>
        <input
          id="q-home"
          type="search"
          placeholder="現在地・駅・店舗名などから探す"
        />
      </label>

      <button id="home-cart-btn" class="icon-btn" aria-label="カートを開く">
        <!-- カートアイコン -->
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path
            d="M6 6h14l-1.5 8.5a2 2 0 0 1-2 1.6H9.2a2 2 0 0 1-2-1.6L6 6Z"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linejoin="round"
          />
          <path
            d="M6 6l-1-2H3"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linecap="round"
          />
          <circle cx="9.5" cy="19.5" r="1.5" fill="currentColor" />
          <circle cx="17.5" cy="19.5" r="1.5" fill="currentColor" />
        </svg>
        <span id="home-cart-badge" class="badge">0</span>
      </button>
    </div>

    <!-- ホーム -->
    <main id="page-home" class="page active">
      <section class="sec">
        <div class="sec-head">
          <h2>現在地付近のお店</h2>
          <a id="more-near">もっと見る ›</a>
        </div>
        <div id="near-carousel" class="carousel"></div>
      </section>

      <section class="sec">
        <div class="sec-head">
          <h2>最近追加されたお店</h2>
          <a id="more-recent">もっと見る ›</a>
        </div>
        <div id="recent-carousel" class="carousel"></div>
      </section>
    </main>

    <!-- Discover（地図フルスクリーン） -->
    <main id="page-discover" class="page">
      <div id="map"></div>

      <!-- マップ上の操作UI -->
      <div class="map-ui">
        <button id="btn-filter" class="fab fab-left" aria-label="絞り込み">
          <svg viewBox="0 0 24 24" width="22" height="22">
            <path
              d="M3 6h18M7 12h10M10 18h4"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
        </button>

        <label class="map-search">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path
              d="M21 21l-3.8-3.8M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"
              stroke="#8a8278"
              stroke-width="1.6"
              stroke-linecap="round"
            />
          </svg>
          <input
            id="q-map"
            type="search"
            placeholder="現在地・駅・店舗名などから探す"
          />
        </label>

        <button id="btn-locate" class="fab fab-right" aria-label="現在地と周辺">
          <!-- コンパスアイコン -->
          <svg viewBox="0 0 24 24" width="22" height="22">
            <circle
              cx="12"
              cy="12"
              r="9"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            />
            <path
              d="M14.5 9.5l-2.7 6-1.3-1.3-1.3-1.3 5.3-3.4z"
              fill="currentColor"
            />
          </svg>
        </button>
      </div>

      <div id="mapSheet" class="map-sheet" aria-hidden="true"></div>
    </main>

    <!-- お気に入り一覧 -->
    <main id="page-fav" class="page">
      <h2>お気に入り</h2>
      <div id="fav-empty" class="muted" style="display: none">
        まだお気に入り店舗がありません。店舗ページのハートをタップすると追加できます。
      </div>
      <div id="fav-list"></div>
    </main>

    <!-- 店舗ページ -->
    <!-- 店舗ページ -->
    <main id="page-shop" class="page">
      <div class="shop-hero"><img id="shop-photo" alt="" /></div>

      <div class="shop-title">
        <h1 id="shop-name"></h1>
        <button id="btn-fav" class="heart" aria-label="お気に入り">
          <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
            <path
              d="m12 21-1.45-1.32C6 15.36 3 12.61 3 9.28 3 6.5 5.24 4.5 7.88 4.5c1.45 0 2.87.64 3.78 1.67A5.2 5.2 0 0 1 15.44 4.5C18.08 4.5 20.3 6.5 20.3 9.28c0 3.33-3 6.08-7.55 10.4L12 21Z"
              fill="none"
              stroke="currentColor"
              stroke-width="1.6"
              stroke-linejoin="round"
            />
          </svg>
        </button>
      </div>

      <div class="meta-row">
        <span id="shop-category"></span>
        <span id="shop-station"></span>
        <span id="shop-distance"></span>
      </div>

      <div class="section">
        <h3>提供中の商品</h3>
        <div id="offer-list" class="offer-list"></div>
      </div>

      <div class="section contact">
        <h3>店舗情報</h3>
        <div id="shop-address"></div>
        <div id="shop-tel"></div>
        <div id="shop-links"></div>
      </div>

      <div class="section">
        <h3>マップ</h3>
        <div id="shop-map"></div>
      </div>
    </main>

    <!-- ★ カートバーは main の外に配置（position: fixed なので表示は同じ） -->
    <div id="cart-bar" class="cart-bar" style="display: none">
      <div><b id="cart-total">¥0</b>・<span id="cart-count">0</span>点</div>
      <button id="btn-order" class="btn">注文する</button>
    </div>

    <!-- タブバー -->
    <nav class="tabbar">
      <!-- ホーム -->
      <button data-page="home" class="active">
        <svg viewBox="0 0 24 24" fill="none">
          <path
            d="M3 10.5 12 4l9 6.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-9.5Z"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linejoin="round"
          />
        </svg>
        <small>ホーム</small>
      </button>

      <!-- お店を探す -->
      <button data-page="discover">
        <svg viewBox="0 0 24 24" fill="none">
          <path
            d="M21 21l-3.8-3.8M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linecap="round"
          />
        </svg>
        <small>お店を探す</small>
      </button>

      <!-- QR読み取り（順番をここへ、ラベル変更） -->
      <button id="nav-scan">
        <svg viewBox="0 0 24 24" fill="none">
          <path
            d="M4 7V4h3M20 7V4h-3M4 17v3h3M20 17v3h-3M6 10h12v4H6z"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <small>QR読み取り</small>
      </button>

      <!-- お気に入り -->
      <button data-page="fav">
        <svg viewBox="0 0 24 24" fill="none">
          <path
            d="m12 21-1.45-1.32C6 15.36 3 12.61 3 9.28 3 6.5 5.24 4.5 7.88 4.5c1.45 0 2.87.64 3.78 1.67A5.2 5.2 0 0 1 15.44 4.5C18.08 4.5 20.3 6.5 20.3 9.28c0 3.33-3 6.08-7.55 10.4L12 21Z"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linejoin="round"
          />
        </svg>
        <small>お気に入り</small>
      </button>

      <!-- マイページ -->
      <button data-page="me">
        <svg viewBox="0 0 24 24" fill="none">
          <path
            d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm8 9a8 8 0 1 0-16 0"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linecap="round"
          />
        </svg>
        <small>マイページ</small>
      </button>
    </nav>

    <!-- 予約QRモーダル -->
    <div id="modal" aria-hidden="true">
      <div
        style="
          background: #fff;
          padding: 20px;
          border-radius: 12px;
          max-width: 300px;
          text-align: center;
        "
      >
        <canvas id="qr"></canvas>
        <div
          id="codeTxt"
          style="margin-top: 8px; font-size: 20px; font-weight: bold"
        ></div>
        <div id="pickupWindow" class="muted" style="margin: 8px 0"></div>
        <div style="margin-top: 12px">
          <button id="closeBtn" class="primary" style="background: #666">
            閉じる
          </button>
          <button id="saveBtn" class="primary">保存</button>
          <button id="cancelBtn" class="danger">キャンセル</button>
        </div>
      </div>
    </div>

    <!-- ライブスキャン -->
    <div id="liveScan" class="live-scan" aria-hidden="true">
      <video id="qrVideo" playsinline></video>
      <button
        id="scanClose"
        class="primary close-btn"
        onclick="closeLiveScan()"
      >
        閉じる
      </button>
    </div>

    <script>
      /* ============== 設定 ============== */
      const CONFIG = {
        LIFF_ID: "2008020661-mYj1EELk",
        API_BASE: "https://line-food-mvp.vercel.app",
        SUPABASE_URL: "https://wpxkjwnfofqdmfukrnqm.supabase.co",
        SUPABASE_ANON_KEY:
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndweGtqd25mb2ZxZG1mdWtybnFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MzQ0OTcsImV4cCI6MjA3MjExMDQ5N30.Aiiuba6dNu_7ZMSns_6D1atbsIs9_PwmLpbVEpgG1yY",
      };
      const BOT_BASIC_ID = "@862eqkrz";

      /* ============== 状態 ============== */
      let g = { userId: null, pos: null };
      let mapApi; // 抽象化API
      let map; // Leafletインスタンス（互換のため保持）
      let userMarker; // 現在地マーカー
      let mapAutoFitDone = false; // 初回/強制時のみ自動フィット
      let shopMapApi; // 店舗ページ用のミニマップ
      var liveScanner = typeof liveScanner === "undefined" ? null : liveScanner;
      let currentShopOffer = null;

      // --- Leaflet(店舗マップ)のサイズ確定を確実にする ---
      function scheduleShopMapFix() {
        if (!shopMapApi) return;
        // レイアウト確定→少し後→さらに後 の三段で保険をかける
        requestAnimationFrame(() => {
          shopMapApi.invalidateSize();
          setTimeout(() => shopMapApi && shopMapApi.invalidateSize(), 120);
          setTimeout(() => shopMapApi && shopMapApi.invalidateSize(), 400);
        });
      }

      // ---- お気に入り：ローカル保存＆UI適用 ----
      const LS_FAV_NS = "mottaina:fav:";
      function readJSON(k, fb) {
        try {
          return JSON.parse(localStorage.getItem(k) || "");
        } catch {
          return fb;
        }
      }
      function writeJSON(k, v) {
        localStorage.setItem(k, JSON.stringify(v));
      }
      function applyHeart(el, on) {
        el?.classList.toggle("active", !!on);
        el?.setAttribute("aria-pressed", on ? "true" : "false");
      }

      // --- カート／チェックアウト用の拡張状態 ---
      g.cart = {}; // { offerId: qty }
      g.currentShop = null; // レンダリング中の店舗情報
      g.currentOffers = []; // 店舗の提供中オファー配列
      g.favTouched = new Set(); // ★ 追加：ユーザーが一度でもハートを触った shopId を保持
      g.favSnapshot = null; // お気に入り一覧の入室時スナップショット

      // --- 表示ユーティリティ ---
      function yen(n) {
        return "¥" + Number(n || 0).toLocaleString();
      }
      // 数量バッジ更新
      function updateHomeCartBadge() {
        try {
          const badge = document.getElementById("home-cart-badge");
          if (!badge) return;
          const count = Object.values(g.cart || {}).reduce(
            (a, v) => a + (v || 0),
            0
          );
          if (count > 0) {
            badge.textContent = String(count);
            badge.style.display = "inline-block";
          } else {
            badge.style.display = "none";
          }
        } catch {}
      }

      // --- ホーム右上のカート数量バッジを同期 ---
      function updateHomeCartBadge() {
        const badge = document.getElementById("home-cart-badge");
        if (!badge) return;
        const count = Object.values(g.cart || {}).reduce(
          (a, v) => a + (v || 0),
          0
        );
        if (count > 0) {
          badge.textContent = String(count);
          badge.style.display = "inline-block";
        } else {
          badge.style.display = "none";
        }
      }

      // 安全にテキストを入れるヘルパ
      function setTextIf(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
      }

      // --- サイレント予約（alert出さない版） ---
      async function reserveSilently(offer) {
        try {
          const idToken = liff.getIDToken();
          const r = await fetch(CONFIG.API_BASE + "/api/reserve", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + idToken,
            },
            body: JSON.stringify({ offer_id: offer.id }),
          });
          const data = await r.json().catch(() => null);
          if (!r.ok || !data?.ok) {
            const msg = data?.error || "reserve_failed";
            return { ok: false, error: msg };
          }
          // キャッシュも更新
          myActive.set(offer.id, {
            id: data.reservation.id,
            status: "reserved",
            pickup_code: data.reservation.pickup_code || null,
          });
          return { ok: true, reservation: data.reservation };
        } catch (e) {
          return { ok: false, error: e?.message || "reserve_failed" };
        }
      }

      // --- サイレント決済（alert出さない版：テスト用エンドポイント） ---
      async function payReservationSilently(reservationId) {
        try {
          const idToken = liff.getIDToken();
          const r = await fetch(CONFIG.API_BASE + "/api/pay/fake-complete", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + idToken,
            },
            body: JSON.stringify({ reservation_id: reservationId }),
          });
          const j = await r.json().catch(() => null);
          if (!r.ok || !j?.ok) {
            return { ok: false, error: j?.error || "pay_failed" };
          }
          return { ok: true, reservation: j.reservation };
        } catch (e) {
          return { ok: false, error: e?.message || "pay_failed" };
        }
      }

      // --- チェックアウトUI（簡易オーバーレイを動的生成） ---
      function openCheckout() {
        const offers = g.currentOffers || [];
        const items = Object.entries(g.cart); // [offerId, qty]
        if (!items.length) return;

        // オーバーレイDOMを動的に作成
        let ov = document.getElementById("checkoutOverlay");
        if (!ov) {
          ov = document.createElement("div");
          ov.id = "checkoutOverlay";
          ov.style.cssText =
            "position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:2147483646;display:flex;align-items:center;justify-content:center;padding:16px;";
          ov.innerHTML = `
      <div id="checkoutPanel" style="background:#fff;max-width:520px;width:100%;border-radius:12px;padding:16px;">
        <h3 style="margin:0 0 8px;">注文内容の確認</h3>
        <div id="checkoutList" style="max-height:45vh;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:10px;"></div>
        <div class="row" style="margin:8px 0">
          <div><b id="checkoutTotal"></b> / <span id="checkoutCount"></span>点</div>
          <div style="display:flex;gap:8px;">
            <button id="checkoutCancel" class="secondary">戻る</button>
            <button id="checkoutPay" class="primary">決済へ進む</button>
          </div>
        </div>
      </div>`;
          document.body.appendChild(ov);
        }

        // リスト描画
        const listEl = ov.querySelector("#checkoutList");
        let total = 0,
          count = 0;
        listEl.innerHTML = items
          .map(([id, q]) => {
            const of = offers.find((o) => String(o.id) === String(id));
            const price = of?.price || 0;
            total += price * q;
            count += q;
            const title = of?.title || "商品";
            const t = `${fmtTime(of.pickup_start)}–${fmtTime(of.pickup_end)}`;
            return `
      <div style="display:flex;gap:10px;align-items:center;border-bottom:1px solid #f0f0f0;padding:8px 0;">
        <img src="${imgFor(
          of
        )}" alt="" style="width:64px;height:48px;object-fit:cover;border-radius:6px">
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${title}</div>
          <div class="muted" style="font-size:12px">受取 ${t}</div>
        </div>
        <div style="text-align:right;min-width:90px">${yen(price)} × ${q}</div>
      </div>`;
          })
          .join("");
        ov.querySelector("#checkoutTotal").textContent = yen(total);
        ov.querySelector("#checkoutCount").textContent = count;

        // ハンドラ
        ov.querySelector("#checkoutCancel").onclick = () => {
          ov.remove();
        };
        ov.querySelector("#checkoutPay").onclick = async () => {
          const btn = ov.querySelector("#checkoutPay");
          btn.disabled = true;
          btn.textContent = "処理中…";
          try {
            if (!(await ensureFriend())) {
              btn.disabled = false;
              btn.textContent = "決済へ進む";
              return;
            }

            // 1) 予約を作成
            const reservations = [];
            for (const [id, qty] of items) {
              const of = offers.find((o) => String(o.id) === String(id));
              for (let i = 0; i < qty; i++) {
                const rr = await reserveSilently(of);
                if (!rr.ok) {
                  alert(`予約に失敗: ${of?.title || "商品"}… ${rr.error}`);
                } else {
                  reservations.push(rr.reservation);
                }
              }
            }

            if (!reservations.length) {
              alert("予約が1件も作成できませんでした。");
              btn.disabled = false;
              btn.textContent = "決済へ進む";
              return;
            }

            // 2) まとめて（テスト）決済
            const results = [];
            for (const r of reservations) {
              const pr = await payReservationSilently(r.id);
              if (!pr.ok) {
                results.push({ ok: false, code: "—", error: pr.error });
              } else {
                results.push({
                  ok: true,
                  code: pr.reservation.pickup_code || "—",
                  resv: pr.reservation,
                });
              }
            }

            // 3) 結果表示（簡易）
            const okCnt = results.filter((x) => x.ok).length;
            const ngCnt = results.length - okCnt;
            const codes = results
              .filter((x) => x.ok)
              .map((x) => x.code)
              .join("\n");
            alert(
              `決済完了: ${okCnt}件 / 失敗: ${ngCnt}件\n受取コード:\n${
                codes || "—"
              }`
            );

            // カートクリア＆UI更新
            g.cart = {};
            // バーを隠す
            const bar = document.getElementById("cart-bar");
            if (bar) bar.style.display = "none";
            document.getElementById("cart-total").textContent = "¥0";
            document.getElementById("cart-count").textContent = "0";

            // 一覧を最新化
            await loadMyReservations();
            await loadOffers();

            ov.remove();
          } finally {
            btn.disabled = false;
            btn.textContent = "決済へ進む";
          }
        };
      }

      /* ============== ユーティリティ ============== */
      function haversine(a, b) {
        const toRad = (d) => (d * Math.PI) / 180,
          R = 6371;
        const dLat = toRad(b.lat - a.lat),
          dLng = toRad(b.lng - a.lng);
        const sa =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(toRad(a.lat)) *
            Math.cos(toRad(b.lat)) *
            Math.sin(dLng / 2) ** 2;
        return 2 * R * Math.asin(Math.sqrt(sa));
      }
      function fmtTime(s) {
        const d = new Date(s),
          h = String(d.getHours()).padStart(2, "0"),
          m = String(d.getMinutes()).padStart(2, "0");
        return `${h}:${m}`;
      }
      function parseShopId(v) {
        try {
          const s = String(v);
          const m = s.match(/^shop:(\d+)$/);
          if (m) return Number(m[1]);
          const o = JSON.parse(s);
          if (o && o.shop_id) return Number(o.shop_id);
        } catch {}
        return null;
      }

      // ===== お気に入り：共通ユーティリティ =====
      function isLIFFInClient() {
        return (
          typeof liff !== "undefined" &&
          liff &&
          typeof liff.isInClient === "function" &&
          liff.isInClient()
        );
      }
      async function getUserKey() {
        try {
          if (isLIFFInClient()) {
            if (!liff.isLoggedIn()) await liff.login();
            const prof = await liff.getProfile();
            return prof?.userId || "anon";
          }
        } catch {}
        return "anon";
      }
      function favLSKey(userKey) {
        return "mottaina:fav:" + userKey;
      }
      function readFavSetSync(userKey) {
        try {
          return new Set(
            JSON.parse(localStorage.getItem(favLSKey(userKey)) || "[]")
          );
        } catch {
          return new Set();
        }
      }
      function writeFavSetSync(userKey, set) {
        try {
          localStorage.setItem(favLSKey(userKey), JSON.stringify([...set]));
        } catch {}
      }
      function applyFavUI(btn, isFav) {
        btn?.classList.toggle("active", !!isFav);
        btn?.setAttribute("aria-pressed", isFav ? "true" : "false");
      }

      // ===== サーバ同期（追加／削除） =====
      // ===== お気に入りAPI（追加／削除） =====

      // ---- お気に入りAPI（追加／削除）: 401/403 はロールバックしない ----
      function softFail(status) {
        return [400, 401, 403, 404, 405].includes(status);
      }

      async function favoriteAdd(shopId) {
        const sid = String(shopId);
        const idToken =
          typeof liff !== "undefined" && liff.getIDToken
            ? liff.getIDToken()
            : "";
        const payload = {
          shop_id: /^\d+$/.test(sid) ? Number(sid) : sid,
          shopId: sid,
        };
        const headers = { "Content-Type": "application/json" };
        if (idToken) headers.Authorization = "Bearer " + idToken;

        try {
          const r = await fetch(`${CONFIG.API_BASE}/api/favorite-add`, {
            method: "POST",
            headers,
            body: JSON.stringify(payload),
          });
          // 409=既に登録 → OK扱い
          if (r.ok || r.status === 409) return { ok: true };
          // ソフトエラーは UI をロールバックしない
          if (softFail(r.status))
            return { ok: false, unsupported: true, status: r.status };
          return {
            ok: false,
            status: r.status,
            text: await r.text().catch(() => ""),
          };
        } catch (e) {
          // ネットワーク等は“未対応扱い”にして UI を保つ
          return { ok: false, unsupported: true, error: e?.message };
        }
      }

      async function favoriteRemove(shopId) {
        const sid = String(shopId);
        const idToken =
          typeof liff !== "undefined" && liff.getIDToken
            ? liff.getIDToken()
            : "";
        const payload = {
          shop_id: /^\d+$/.test(sid) ? Number(sid) : sid,
          shopId: sid,
        };
        const headers = { "Content-Type": "application/json" };
        if (idToken) headers.Authorization = "Bearer " + idToken;

        // ① 推奨エンドポイント
        try {
          const r = await fetch(`${CONFIG.API_BASE}/api/favorite-remove`, {
            method: "POST",
            headers,
            body: JSON.stringify(payload),
          });
          if (r.ok) return { ok: true };
          if (softFail(r.status))
            return { ok: false, unsupported: true, status: r.status };
        } catch {}

        // ② 互換フォールバック
        try {
          const r2 = await fetch(
            `${CONFIG.API_BASE}/api/favorites?shopId=${encodeURIComponent(
              sid
            )}`,
            {
              method: "DELETE",
              headers: idToken ? { Authorization: "Bearer " + idToken } : {},
            }
          );
          if (r2.ok) return { ok: true };
          if (softFail(r2.status))
            return { ok: false, unsupported: true, status: r2.status };
          return { ok: false, status: r2.status };
        } catch (e) {
          return { ok: false, unsupported: true, error: e?.message };
        }
      }

      // 既存互換（QRスキャン側で使用）
      async function favPost(shopId) {
        const r = await favoriteAdd(shopId);
        if (!r.ok && !r.unsupported)
          throw new Error(r.error?.message || "favorite_add_failed");
        return r;
      }

      /* ============== マップ API（Leaflet実装） ============== */
      function createLeafletAPI() {
        let _map,
          _markers = [],
          _userMarker = null;
        return {
          init(id, { center = [35.6812, 139.7671], zoom = 12 } = {}) {
            _map = L.map(id, { zoomControl: true }).setView(center, zoom);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              attribution: "&copy; OpenStreetMap contributors",
            }).addTo(_map);
            return _map;
          },
          addUserMarker(lat, lng) {
            if (!_userMarker) {
              _userMarker = L.circleMarker([lat, lng], {
                radius: 10,
                color: "#2e7d32",
                fillColor: "#66bb6a",
                fillOpacity: 0.9,
                weight: 3,
              })
                .addTo(_map)
                .bindPopup("現在地");
            } else {
              _userMarker.setLatLng([lat, lng]);
            }
            return _userMarker;
          },
          addShopMarker(lat, lng, onClick) {
            const m = L.marker([lat, lng]).addTo(_map);
            if (onClick) m.on("click", onClick);
            _markers.push(m);
            return m;
          },
          clearMarkers() {
            _markers.forEach((m) => _map.removeLayer(m));
            _markers = [];
          },
          fitToBounds(latlngs, { maxZoom = 14, padding = [30, 30] } = {}) {
            if (!latlngs || !latlngs.length) return;
            const b = L.latLngBounds(latlngs);
            _map.fitBounds(b, { maxZoom, padding });
          },
          setCenter(lat, lng, zoom) {
            _map.setView([lat, lng], zoom ?? _map.getZoom());
          },
          invalidateSize() {
            setTimeout(() => _map && _map.invalidateSize(), 0);
          },
          on(ev, handler) {
            _map.on(ev, handler);
          },
          off(ev, handler) {
            _map.off(ev, handler);
          },
          raw() {
            return _map;
          },
          // ★追加：破棄
          destroy() {
            try {
              _map && _map.remove();
            } catch {}
            _map = null;
            _markers = [];
            _userMarker = null;
          },
        };
      }

      function lockMapInteraction(api) {
        const m = api?.raw?.();
        if (!m) return;
        try {
          m.dragging.disable();
          m.touchZoom.disable();
          m.scrollWheelZoom.disable();
          m.doubleClickZoom.disable();
          m.boxZoom.disable();
          m.keyboard.disable();
          if (m.tap) m.tap.disable(); // iOS対策
          if (m.zoomControl) m.removeControl(m.zoomControl);
        } catch (e) {
          console.warn("lockMapInteraction failed", e);
        }
      }

      /* ============== 初期化 ============== */
      async function init() {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const prof = await liff.getProfile();
        g.userId = prof.userId;
        setTextIf("me", "ログイン済み");

        (function () {
          let tap = 0,
            timer = null;
          document
            .getElementById("shop-name")
            ?.addEventListener("click", () => {
              tap++;
              clearTimeout(timer);
              timer = setTimeout(() => (tap = 0), 800);
              if (tap >= 3) {
                tap = 0;
                __cleanFav();
              }
            });
        })();

        // 位置先取り（取得でき次第、地図＆リストに反映）
        try {
          const geo = await new Promise((ok, ng) =>
            navigator.geolocation.getCurrentPosition(ok, ng, {
              enableHighAccuracy: true,
              timeout: 8000,
            })
          );
          g.pos = { lat: geo.coords.latitude, lng: geo.coords.longitude };
          setTextIf("notice", "近い順に表示中");
          if (mapApi && map && window.__lastOffers) {
            mapAutoFitDone = false;
            fitToUserAndNearest(window.__lastOffers, true);
          }
        } catch {
          g.pos = null;
          setTextIf("notice", "位置情報が拒否されました（距離順は概算表示）");
        }

        await loadMyReservations();
        await loadOffers();
      }

      async function loadOffers() {
        const url = new URL(CONFIG.SUPABASE_URL + "/rest/v1/offers");
        url.searchParams.set(
          "select",
          "id,title,price,qty_available,pickup_start,pickup_end,shops:shop_id(id,name,lat,lng,address)"
        );
        url.searchParams.set("status", "eq.active");
        url.searchParams.set("order", "created_at.desc");

        const r = await fetch(url, {
          headers: {
            apikey: CONFIG.SUPABASE_ANON_KEY,
            Authorization: "Bearer " + CONFIG.SUPABASE_ANON_KEY,
          },
        });
        const items = await r.json();

        const list = items
          .map((it) => {
            const shop = it.shops;
            const dist =
              g.pos && shop?.lat && shop?.lng
                ? haversine(g.pos, { lat: shop.lat, lng: shop.lng })
                : null;
            return { ...it, shop, dist };
          })
          .sort((a, b) => {
            if (a.dist == null && b.dist == null) return 0;
            if (a.dist == null) return 1;
            if (b.dist == null) return -1;
            return a.dist - b.dist;
          });

        window.__lastOffers = list;
        render(list);

        // 地図があればもう一度フィット（データ揃ってから）
        if (mapApi && map) fitToUserAndNearest(list, true);
      }

      /* ============== 友だち確認 ============== */
      async function ensureFriend() {
        try {
          const { friendFlag } = await liff.getFriendship();
          if (friendFlag) return true;
          const go = confirm(
            "公式アカウントを友だち追加してください。追加画面を開きますか？"
          );
          if (go)
            liff.openWindow({
              url: `https://line.me/R/ti/p/${BOT_BASIC_ID}`,
              external: true,
            });
          return false;
        } catch {
          alert(
            "友だち状態を確認できませんでした。後でもう一度お試しください。"
          );
          return false;
        }
      }
      async function checkFriendship() {
        try {
          const { friendFlag } = await liff.getFriendship();
          setTextIf(
            "friendStatus",
            friendFlag
              ? "公式アカウントは『友だち』になっています。"
              : "まだ友だちではありません。"
          );
        } catch (e) {
          setTextIf(
            "friendStatus",
            "友だち状態を取得できません（Mini App と Messaging API の関連付けを確認してください）"
          );
          console.error(e);
        }
      }

      /* ============== 予約・決済・モーダル ============== */
      let myActive = new Map(); // offer_id -> { id, status, pickup_code }

      async function reserve(offer, btn) {
        if (offer.qty_available <= 0) {
          const ok = confirm(
            "この商品は在庫0です。サーバ側の sold_out 動作テストとして予約リクエストを送りますか？"
          );
          if (!ok) return;
        }
        if (!(await ensureFriend())) return;

        btn.disabled = true;
        const prev = btn.textContent;
        btn.textContent = "予約中…";
        try {
          const idToken = liff.getIDToken();
          const r = await fetch(CONFIG.API_BASE + "/api/reserve", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + idToken,
            },
            body: JSON.stringify({ offer_id: offer.id }),
          });
          const data = await r.json();

          if (!data.ok) {
            if (data.error === "already_reserved")
              return alert("このお得袋はすでに予約済みです。");
            if (data.error === "sold_out_or_missing")
              return alert("在庫切れ、または見つかりませんでした。");
            throw new Error(data.error || "reserve_failed");
          }

          myActive.set(offer.id, {
            id: data.reservation.id,
            status: "reserved",
            pickup_code: data.reservation.pickup_code || null,
          });

          alert("予約を作成しました。続けて「決済へ進む」を押してください。");
          await loadMyReservations();
          await loadOffers();
        } catch (e) {
          alert("予約に失敗しました：" + e.message);
        } finally {
          btn.disabled = false;
          btn.textContent = prev;
        }
      }

      function showQR({ code, reservationId, shopName, windowText }) {
        const modal = document.getElementById("modal");
        const canvas = document.getElementById("qr");
        const codeTxt = document.getElementById("codeTxt");
        const pick = document.getElementById("pickupWindow");

        if (modal.parentElement !== document.body)
          document.body.appendChild(modal);

        QRCode.toCanvas(canvas, code, { width: 220, margin: 1 }, () => {});
        codeTxt.textContent = code;
        pick.textContent = windowText || "";

        modal.style.display = "flex";
        document.body.classList.add("modal-open");

        const onClose = () => {
          modal.style.display = "none";
          document.body.classList.remove("modal-open");
          if (mapApi) mapApi.invalidateSize();
        };
        document.getElementById("closeBtn").onclick = onClose;
        document.getElementById("saveBtn").onclick = () => {
          const a = document.createElement("a");
          a.href = canvas.toDataURL("image/png");
          a.download = `pickup_${code}.png`;
          a.click();
        };
        const cancelBtn = document.getElementById("cancelBtn");
        if (cancelBtn)
          cancelBtn.onclick = () => cancelReservation(reservationId, onClose);
        modal.onclick = (e) => {
          if (e.target === modal) onClose();
        };
      }

      async function payReservation(reservationId, offer) {
        const idToken = liff.getIDToken();
        const r = await fetch(CONFIG.API_BASE + "/api/pay/fake-complete", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + idToken,
          },
          body: JSON.stringify({ reservation_id: reservationId }),
        });
        const j = await r.json().catch(() => null);
        if (!r.ok || !j?.ok) {
          const msg = j?.error || "pay_failed";
          alert("決済（テスト）に失敗しました：" + msg);
          throw new Error(msg);
        }

        const resv = j.reservation;
        myActive.set(resv.offer_id, {
          id: resv.id,
          status: "paid",
          pickup_code:
            resv.pickup_code ||
            myActive.get(resv.offer_id)?.pickup_code ||
            null,
        });

        showQR({
          code: myActive.get(resv.offer_id)?.pickup_code || resv.pickup_code,
          reservationId: resv.id,
          shopName: offer?.shops?.name || "店舗",
          windowText: `受取時間 ${fmtTime(offer.pickup_start)}–${fmtTime(
            offer.pickup_end
          )}`,
        });

        await loadMyReservations();
        await loadOffers();
      }

      async function cancelReservation(reservationId, onClose) {
        if (!reservationId) return alert("予約IDが見つかりません");
        if (!confirm("この予約をキャンセルしますか？")) return;
        try {
          const idToken = liff.getIDToken();
          const r = await fetch(CONFIG.API_BASE + "/api/cancel", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + idToken,
            },
            body: JSON.stringify({ reservation_id: reservationId }),
          });
          let data;
          try {
            data = await r.json();
          } catch {}
          if (!r.ok || !data?.ok) {
            const msg = data?.error || "cancel_failed";
            if (msg === "too_late")
              return alert("受取開始後はキャンセルできません。");
            if (msg === "not_cancellable")
              return alert("この予約はキャンセルできません。");
            return alert("キャンセルに失敗しました：" + msg);
          }
          alert("キャンセルしました。");
          if (typeof onClose === "function") onClose();
          await loadOffers();
        } catch (e) {
          alert("キャンセルに失敗しました：" + e.message);
        }
      }

      /* ============== ホーム描画 & 地図描画 ============== */
      function imgFor(it) {
        return (
          it.image_url ||
          it.shops?.image_url ||
          `https://placehold.co/800x600/j5b09d/ffffff?text=${encodeURIComponent(
            it.shops?.name || "Shop"
          )}`
        );
      }

      function buildCardHTML(it) {
        const shop = it.shop || it.shops;
        const time = `${fmtTime(it.pickup_start)}–${fmtTime(it.pickup_end)}`;
        const dist = it.dist != null ? `${it.dist.toFixed(1)}km` : "";
        const sold = it.qty_available <= 0;
        return `
          <article class="card-lg" data-offer="${it.id}">
            <img src="${imgFor(it)}" alt="">
            <div class="price">¥${it.price}</div>
            <div class="overlay">
              <div class="title">${shop?.name || "店舗"}</div>
              <div class="meta">
                <span>のこり${it.qty_available}</span>
                <span>${time}</span>
                <span>${dist}</span>
              </div>
              <div style="margin-top:8px">
                <button class="primary btn-resv" ${sold ? "disabled" : ""}>${
          sold ? "在庫なし" : "予約へ進む"
        }</button>
              </div>
            </div>
          </article>`;
      }

      function renderHomeSections(list) {
        const near = [...list]
          .sort((a, b) => {
            if (a.dist == null && b.dist == null) return 0;
            if (a.dist == null) return 1;
            if (b.dist == null) return -1;
            return a.dist - b.dist;
          })
          .slice(0, 12);
        const recent = [...list].slice(0, 12);

        const nearEl = document.getElementById("near-carousel");
        const recEl = document.getElementById("recent-carousel");
        nearEl.innerHTML = near.map(buildCardHTML).join("");
        recEl.innerHTML = recent.map(buildCardHTML).join("");

        [
          ...nearEl.querySelectorAll(".card-lg"),
          ...recEl.querySelectorAll(".card-lg"),
        ].forEach((card) => {
          const id = card.getAttribute("data-offer");
          const offer = list.find((x) => String(x.id) === String(id));

          // 予約ボタン
          card
            .querySelector(".btn-resv")
            ?.addEventListener("click", (ev) => reserve(offer, ev.target));

          // ★カード全体タップで店舗ページ表示（ボタンのクリックは除外）
          card.addEventListener("click", (ev) => {
            if (ev.target.closest("button")) return;
            const sid = offer?.shop?.id ?? offer?.shops?.id;
            if (sid) openShopPage(sid, offer);
          });
        });
      }

      function render(list) {
        renderHomeSections(list);
        renderMap(list);
      }

      // ボトムシート
      const mapSheetEl = document.getElementById("mapSheet");
      function hideMapSheet() {
        if (!mapSheetEl) return;
        mapSheetEl.classList.remove("show");
        mapSheetEl.innerHTML = "";
      }
      function showMapSheet(offer) {
        if (!mapSheetEl) return;
        const html = `<div class="handle"></div>${buildCardHTML(offer)}`;
        mapSheetEl.innerHTML = html;
        mapSheetEl.classList.add("show");

        mapSheetEl
          .querySelector(".btn-resv")
          ?.addEventListener("click", (ev) => {
            reserve(offer, ev.target);
          });

        mapSheetEl
          .querySelector(".card-lg")
          ?.addEventListener("click", (ev) => {
            if (ev.target.closest("button")) return;
            const sid = offer?.shop?.id ?? offer?.shops?.id;
            if (sid) openShopPage(sid, offer);
          });
      }

      function renderMap(list) {
        if (!mapApi) {
          mapApi = createLeafletAPI();
          map = mapApi.init("map", { center: [35.6812, 139.7671], zoom: 12 });
          // サイズ補正
          setTimeout(() => mapApi.invalidateSize(), 0);
          // 地図タッチでシートを閉じる
          mapApi.off("click", hideMapSheet);
          mapApi.off("movestart", hideMapSheet);
          mapApi.on("click", hideMapSheet);
          mapApi.on("movestart", hideMapSheet);
        }

        // 既存マーカークリア（現在地は addUserMarker で管理）
        mapApi.clearMarkers();

        // 現在地マーカー
        if (g.pos) {
          userMarker = mapApi.addUserMarker(g.pos.lat, g.pos.lng);
        }

        // 店舗マーカー
        (list || []).forEach((it) => {
          const s = it.shop || it.shops;
          if (s?.lat && s?.lng) {
            mapApi.addShopMarker(s.lat, s.lng, () => showMapSheet(it));
          }
        });

        // 初回は自動フィット
        if (!mapAutoFitDone) fitToUserAndNearest(list, false);
      }

      async function fetchShopDetail(shopId) {
        const idStr = String(shopId || "").trim();
        if (!idStr) return null;

        const base = `${CONFIG.SUPABASE_URL}/rest/v1/shops`;
        const headers = {
          apikey: CONFIG.SUPABASE_ANON_KEY,
          Authorization: "Bearer " + CONFIG.SUPABASE_ANON_KEY,
          Prefer: "return=representation",
          Accept: "application/vnd.pgrst.object+json", // 1件をオブジェクトで受ける
        };

        const selects = [
          "id,name,lat,lng,address,category,station,photo_url,tel,website,instagram,twitter,facebook",
          "id,name,lat,lng,address,category,station,photo_url,tel,website,instagram",
          "id,name,lat,lng,address,category,station,photo_url",
        ];

        for (const sel of selects) {
          const url = new URL(base);
          url.searchParams.set("id", "eq." + idStr);
          url.searchParams.set("select", sel);
          url.searchParams.set("limit", "1");
          try {
            const r = await fetch(url.toString(), { headers });
            if (r.ok) return await r.json();
            if (r.status !== 400) {
              // 400以外はリトライせず抜ける
              console.warn(
                "fetchShopDetail non-400",
                r.status,
                await r.text().catch(() => "")
              );
              break;
            }
          } catch (e) {
            console.warn("fetchShopDetail attempt failed", e);
          }
        }
        return null;
      }

      // ========== お気に入り一覧を描画（ID正規化＋フォールバック付き） ==========
      async function renderFavList() {
        const wrap = document.getElementById("fav-list");
        if (!wrap) return;
        wrap.innerHTML = '<p class="muted">読み込み中…</p>';

        const userKey = await getUserKey();
        // 1) 端末保存のIDを正規化（"shop:123" -> "123"、空は除去）
        const raw = readFavSetSync(userKey);
        const normalized = new Set();
        [...raw].forEach((v) => {
          const s = String(v || "").trim();
          if (!s) return;
          const m = s.match(/^shop:(\d+)$/);
          normalized.add(m ? m[1] : s);
        });
        // 変化があれば保存し直し（以後の不具合予防）
        if ([...raw].join("|") !== [...normalized].join("|")) {
          writeFavSetSync(userKey, normalized);
        }

        const ids = [...normalized];
        if (ids.length === 0) {
          wrap.innerHTML = '<p class="muted">お気に入り店舗がありません</p>';
          return;
        }

        // 2) 画面に既にあるオファー一覧から、店情報のキャッシュを作る（フォールバック用）
        const fromList = {};
        (window.__lastOffers || []).forEach((o) => {
          const s = o.shop || o.shops;
          if (s?.id != null) {
            fromList[String(s.id)] = {
              id: s.id,
              name: s.name || "",
              address: s.address || "",
              photo_url: s.photo_url || "",
            };
          }
        });

        // 3) 店舗詳細を取得（失敗したら fromList で補完）
        const details = await Promise.all(
          ids.map(async (sid) => {
            const d = await fetchShopDetail(sid).catch(() => null);
            return d && d.name ? d : fromList[sid] || null;
          })
        );

        // 4) 描画
        wrap.innerHTML = "";
        details.forEach((shop, idx) => {
          const sid = ids[idx];
          // 最後の砦：それでも名前が無いならIDだけでも出す
          const name = shop?.name || `(ID: ${sid})`;
          const address = shop?.address || "";
          const photo =
            shop?.photo_url ||
            (name
              ? `https://placehold.co/800x600/j5b09d/ffffff?text=${encodeURIComponent(
                  name
                )}`
              : `https://placehold.co/800x600`);

          const el = document.createElement("article");
          el.className = "fav-item";
          el.innerHTML = `
      <img class="thumb" src="${photo}" alt="">
      <div class="info">
        <div class="title">${name}</div>
        <div class="meta">${address}</div>
      </div>
      <button class="heart ${
        normalized.has(sid) ? "active" : ""
      }" aria-label="お気に入り">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
          <path d="m12 21-1.45-1.32C6 15.36 3 12.61 3 9.28 3 6.5 5.24 4.5 7.88 4.5c1.45 0 2.87.64 3.78 1.67A5.2 5.2 0 0 1 15.44 4.5C18.08 4.5 20.3 6.5 20.3 9.28c0 3.33-3 6.08-7.55 10.4L12 21Z"
                fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
        </svg>
      </button>
    `;

          // カードタップで店舗ページへ
          el.addEventListener("click", (ev) => {
            if (ev.target.closest(".heart")) return;
            openShopPage(sid);
          });

          // 右側ハートのトグル（楽観更新＋サーバ同期）
          const btn = el.querySelector(".heart");
          btn.addEventListener("click", async (ev) => {
            ev.stopPropagation();
            if (btn.dataset.busy === "1") return;
            btn.dataset.busy = "1";

            const nowFav = normalized.has(sid);
            const willFav = !nowFav;

            // 楽観反映＋保存
            if (willFav) normalized.add(sid);
            else normalized.delete(sid);
            writeFavSetSync(userKey, normalized);
            applyFavUI(btn, willFav);

            // サーバ同期（LIFF内のみ）
            if (isLIFFInClient()) {
              try {
                const r = willFav
                  ? await favoriteAdd(sid)
                  : await favoriteRemove(sid);
                if (!(r?.ok || r?.unsupported)) {
                  // 真の失敗 → ロールバック
                  if (willFav) normalized.delete(sid);
                  else normalized.add(sid);
                  writeFavSetSync(userKey, normalized);
                  applyFavUI(btn, !willFav);
                  alert("お気に入りの同期に失敗しました");
                }
              } catch {
                if (willFav) normalized.delete(sid);
                else normalized.add(sid);
                writeFavSetSync(userKey, normalized);
                applyFavUI(btn, !willFav);
                alert("お気に入りの更新に失敗しました");
              }
            }

            btn.dataset.busy = "0";

            // 解除したらカードも消す
            if (!willFav) {
              el.remove();
              if ([...normalized].length === 0) {
                wrap.innerHTML =
                  '<p class="muted">お気に入り店舗がありません</p>';
              }
            }
          });

          wrap.appendChild(el);
        });
      }

      async function openShopPage(shopId, offerHint) {
        const all = window.__lastOffers || [];
        const offers = all.filter(
          (o) => String(o.shop?.id ?? o.shops?.id) === String(shopId)
        );

        // まず手元の情報（hint/オファー）で描画してページを表示
        const baseShop =
          offerHint?.shops ||
          offerHint?.shop ||
          offers[0]?.shops ||
          offers[0]?.shop ||
          {};

        document.dispatchEvent(
          new CustomEvent("app:showPage", { detail: { name: "shop" } })
        );
        renderShopPage(baseShop, offers);
        history.pushState(
          { page: "shop", id: String(shopId) },
          "",
          "#shop:" + shopId
        );

        // 詳細は後から上書き（失敗しても画面は出たまま）
        try {
          const detail = await fetchShopDetail(shopId);
          if (detail) {
            const merged = Object.assign({}, baseShop, detail);
            renderShopPage(merged, offers);
          }
        } catch (e) {
          console.warn("fetchShopDetail failed:", e);
        }
      }

      function renderShopPage(shop, offers) {
        // 見出し・基本
        document.getElementById("shop-name").textContent = shop?.name || "店舗";
        document.getElementById("shop-category").textContent = shop?.category
          ? `業種：${shop.category}`
          : "";
        document.getElementById("shop-station").textContent = shop?.station
          ? `最寄り：${shop.station}`
          : "";

        const dist =
          g.pos && shop?.lat && shop?.lng
            ? haversine(g.pos, { lat: shop.lat, lng: shop.lng })
            : null;
        document.getElementById("shop-distance").textContent =
          dist != null ? `距離：${dist.toFixed(1)}km` : "";

        const hero = document.getElementById("shop-photo");
        hero.src =
          shop?.photo_url ||
          (shop?.name
            ? `https://placehold.co/1200x600/j5b09d/ffffff?text=${encodeURIComponent(
                shop.name
              )}`
            : `https://placehold.co/1200x600`);

        document.getElementById("shop-address").textContent =
          shop?.address || "";

        document.getElementById("shop-tel").innerHTML = shop?.tel
          ? `TEL：<a href="tel:${shop.tel}">${shop.tel}</a>`
          : "";

        const links = [];
        if (shop?.website)
          links.push(
            `<a href="${shop.website}" target="_blank" rel="noopener">公式サイト</a>`
          );
        if (shop?.instagram)
          links.push(
            `<a href="${shop.instagram}" target="_blank" rel="noopener">Instagram</a>`
          );
        if (shop?.twitter)
          links.push(
            `<a href="${shop.twitter}" target="_blank" rel="noopener">X</a>`
          );
        if (shop?.facebook)
          links.push(
            `<a href="${shop.facebook}" target="_blank" rel="noopener">Facebook</a>`
          );
        document.getElementById("shop-links").innerHTML = links.join(" / ");

        // 商品一覧＋カート
        g.currentShop = shop;
        g.currentOffers = offers;
        g.cart = {}; // 店舗を開いたらカート初期化

        const listEl = document.getElementById("offer-list");
        listEl.innerHTML = "";

        // こう直してください
        const updateCartBar = () => {
          let count = 0,
            total = 0;
          for (const id in g.cart) {
            const of = offers.find((o) => String(o.id) === String(id));
            const q = g.cart[id] || 0;
            count += q;
            total += (of?.price || 0) * q;
          }
          const bar = document.getElementById("cart-bar");
          // 店舗ページでは常時表示（ページ切替側で非表示にします）
          bar.style.display = "flex";

          document.getElementById("cart-total").textContent = "¥" + total;
          document.getElementById("cart-count").textContent = String(count);
          document.getElementById("btn-order").disabled = count === 0;

          // ★追加：ホーム右上のカートバッジも同期（未定義事故防止）
          try {
            updateHomeCartBadge();
          } catch {}
        };

        offers.forEach((of) => {
          const el = document.createElement("div");
          el.className = "offer";
          el.innerHTML = `
    <img src="${imgFor(of)}" alt="">
    <div class="info">
      <div class="name">${of.title || "商品"}</div>
      <div class="time">受取 ${fmtTime(of.pickup_start)}–${fmtTime(
            of.pickup_end
          )}</div>
      <div class="price">${yen(of.price)} ・ 残り${of.qty_available}</div>
    </div>
    <div class="qty">
      <button class="dec" aria-label="減らす">–</button>
      <b class="q">0</b>
      <button class="inc" aria-label="増やす">＋</button>
    </div>
  `;
          const qEl = el.querySelector(".q");
          const setQ = (q) => {
            g.cart[of.id] = q;
            if (q <= 0) delete g.cart[of.id];
            qEl.textContent = String(q);
            updateCartBar();
          };
          el.querySelector(".inc").onclick = () => {
            const cur = g.cart[of.id] || 0;
            if (cur < of.qty_available) setQ(cur + 1);
          };
          el.querySelector(".dec").onclick = () => {
            const cur = g.cart[of.id] || 0;
            if (cur > 0) setQ(cur - 1);
          };
          listEl.appendChild(el);
        });

        // 商品リスト構築の直後に追加
        updateCartBar();

        // --- お気に入り（トグル＋楽観UI＋ローカル保存＋サーバ同期） ---
        {
          const favBtn = document.getElementById("btn-fav");
          if (favBtn) {
            const sid = String(shop?.id ?? shop?.shop_id ?? "");

            (async () => {
              const userKey = await getUserKey();
              const favSet = readFavSetSync(userKey);
              // 既存の誤登録（空ID）を除去
              if (favSet.has("")) {
                favSet.delete("");
                writeFavSetSync(userKey, favSet);
              }

              // 店舗IDが未決定ならUIはオフ/無効化
              if (!sid) {
                applyFavUI(favBtn, false);
                favBtn.disabled = true;
                return;
              }

              let userTouched = g.favTouched.has(sid); // 再描画でも保持

              // ローカル状態を即反映
              applyFavUI(favBtn, favSet.has(sid));

              // タップでトグル（楽観更新→同期→失敗時はロールバック）
              favBtn.onclick = async () => {
                // 二重タップ防止
                if (favBtn.dataset.busy === "1") return;
                favBtn.dataset.busy = "1";

                g.favTouched.add(sid);
                userTouched = true;

                const nowFav = favSet.has(sid);
                const willFav = !nowFav;

                // 楽観反映＋保存
                if (willFav) favSet.add(sid);
                else favSet.delete(sid);
                writeFavSetSync(userKey, favSet);
                applyFavUI(favBtn, willFav);

                // LIFF外はサーバ同期しない（ローカル維持）
                if (!isLIFFInClient()) {
                  favBtn.dataset.busy = "0";
                  return;
                }

                let ok = false;
                let unsupported = false;

                try {
                  const r = willFav
                    ? await favoriteAdd(sid)
                    : await favoriteRemove(sid);
                  ok = !!r?.ok;
                  // 400/404/405 は「未対応」とみなしてロールバックしない
                  unsupported =
                    !!r?.unsupported || [400, 404, 405].includes(r?.status);
                } catch (e) {
                  const s = e?.status;
                  const msg = (e && (e.message || String(e))) || "";
                  unsupported =
                    s === 400 ||
                    s === 404 ||
                    s === 405 ||
                    /bad_request|not\s*found|method\s*not\s*allowed/i.test(msg);
                } finally {
                  favBtn.dataset.busy = "0";
                }

                if (unsupported) {
                  // バックエンド未対応：ローカル状態を維持して終了
                  return;
                }
                if (!ok) {
                  // 真の失敗だけロールバック
                  if (willFav) favSet.delete(sid);
                  else favSet.add(sid);
                  writeFavSetSync(userKey, favSet);
                  applyFavUI(favBtn, !willFav);
                }
              };

              // 初期サーバ状態の上書きは「ユーザー未操作のときだけ」
              try {
                if (!userTouched && isLIFFInClient() && /^\d+$/.test(sid)) {
                  const idToken = liff.getIDToken();
                  const r = await fetch(
                    `${
                      CONFIG.API_BASE
                    }/api/favorites?shopId=${encodeURIComponent(sid)}`,
                    { headers: { Authorization: "Bearer " + idToken } }
                  );
                  const j = await r.json().catch(() => null);

                  // サーバ応答は「false」のときだけ反映（true は信用しない）
                  if (
                    r.ok &&
                    (j?.isFavorited !== undefined || j?.favorited !== undefined)
                  ) {
                    const serverOn = !!(j.isFavorited ?? j.favorited);
                    if (!serverOn && favSet.has(sid)) {
                      favSet.delete(sid);
                      writeFavSetSync(userKey, favSet);
                      applyFavUI(favBtn, false);
                    }
                  }
                }
              } catch (e) {
                console.warn("favorite init failed:", e);
              }
            })();
          }
        }

        // 「注文する」→ チェックアウトオーバーレイを開く
        document.getElementById("btn-order").onclick = () => {
          if (!Object.keys(g.cart).length) return;
          openCheckout();
        };

        // ミニマップ
        setTimeout(() => {
          const lat = Number(shop?.lat);
          const lng = Number(shop?.lng);

          shopMapApi = createLeafletAPI();

          // 店舗座標が取れない場合は東京駅付近にフォールバック
          const center =
            Number.isFinite(lat) && Number.isFinite(lng)
              ? [lat, lng]
              : [35.6812, 139.7671];

          const m = shopMapApi.init("shop-map", {
            center,
            zoom: Number.isFinite(lat) && Number.isFinite(lng) ? 16 : 11,
          });

          // 店舗ピンは必ず立てる
          if (Number.isFinite(lat) && Number.isFinite(lng)) {
            shopMapApi.addShopMarker(lat, lng);
          }

          // 現在地ピンは “おまけ” として置くが、中心合わせには使わない（常に店舗中心）
          if (g.pos?.lat && g.pos?.lng) {
            shopMapApi.addUserMarker(g.pos.lat, g.pos.lng);
          }

          // マップ準備完了時にも念のため店舗中心へ（hidden初期化のズレ対策）
          m.whenReady(() => {
            if (Number.isFinite(lat) && Number.isFinite(lng)) {
              m.setView([lat, lng], 16, { animate: false });
            }
          });

          // ここで操作を完全ロック（ズーム/スクロール不可）
          lockMapInteraction(shopMapApi);

          // レイアウト確定後にサイズ再計測
          scheduleShopMapFix();

          // 再計測の“少し後”にもう一度だけ店舗中心へ（高さ収束後の最終微調整）
          setTimeout(() => {
            const mm = shopMapApi?.raw?.();
            if (mm && Number.isFinite(lat) && Number.isFinite(lng)) {
              mm.setView([lat, lng], 16, { animate: false });
            }
          }, 120);

          // ヒーロー画像のロード後にも再計測＆再センター
          const heroImg = document.getElementById("shop-photo");
          heroImg?.addEventListener(
            "load",
            () => {
              scheduleShopMapFix();
              const mm = shopMapApi?.raw?.();
              if (mm && Number.isFinite(lat) && Number.isFinite(lng)) {
                mm.setView([lat, lng], 16, { animate: false });
              }
            },
            { once: true }
          );

          // ページ全体のサイズ変化にも追随
          if (window.ResizeObserver) {
            if (window.__shopMapRO) window.__shopMapRO.disconnect();
            window.__shopMapRO = new ResizeObserver(() => {
              scheduleShopMapFix();
            });
            window.__shopMapRO.observe(document.getElementById("page-shop"));
          }
        }, 0);
      }

      // 現在地 + 近隣店舗にフィット
      function fitToUserAndNearest(list, force = false) {
        if (!mapApi || !map) return;
        if (mapAutoFitDone && !force) return;

        const targets = [];
        if (g.pos) targets.push([g.pos.lat, g.pos.lng]);

        const shops = (list || [])
          .filter((it) => it?.shops?.lat && it?.shops?.lng)
          .sort((a, b) => (a.dist ?? Infinity) - (b.dist ?? Infinity))
          .slice(0, 6);

        shops.forEach((it) => targets.push([it.shops.lat, it.shops.lng]));

        if (targets.length >= 2) {
          mapApi.fitToBounds(targets, { maxZoom: 14, padding: [30, 30] });
        } else if (targets.length === 1) {
          mapApi.setCenter(targets[0][0], targets[0][1], 13);
        } else {
          mapApi.setCenter(35.6812, 139.7671, 11);
        }
        mapAutoFitDone = true;
      }

      /* ============== スキャン ============== */
      // ---- お気に入りAPI（追加／削除）は上部の定義を使います ----

      function scanByImage() {
        let inp = document.getElementById("qr-file");
        if (!inp) {
          inp = document.createElement("input");
          inp.type = "file";
          inp.accept = "image/*";
          inp.capture = "environment";
          inp.id = "qr-file";
          inp.style.display = "none";
          document.body.appendChild(inp);
        }
        inp.onchange = async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          try {
            const res = await QrScanner.scanImage(file);
            const text = res?.data || res;
            const shopId = parseShopId(text);
            if (!shopId) return alert("QRの形式が不正です");
            if (!(await ensureFriend())) return;
            await favPost(shopId);
            alert("お気に入り店舗に登録しました");
          } catch (err) {
            console.error(err);
            alert("画像からQRを読み取れませんでした");
          } finally {
            e.target.value = "";
          }
        };
        inp.click();
      }

      async function openLiveScan() {
        try {
          if (!(await ensureFriend())) return;
          const box = document.getElementById("liveScan");
          const video = document.getElementById("qrVideo");
          if (!box || !video)
            return alert("ライブスキャンの要素が見つかりません");

          box.classList.add("show");
          document.body.classList.add("live-scan-open");

          if (!window.QrScanner) {
            alert("スキャナを読み込めませんでした");
            return closeLiveScan();
          }

          if (liveScanner) {
            try {
              await liveScanner.stop();
            } catch {}
            liveScanner.destroy();
            liveScanner = null;
          }

          liveScanner = new QrScanner(
            video,
            async (result) => {
              try {
                const text = result?.data || result;
                const shopId = parseShopId(text);
                if (!shopId) {
                  alert("QRの形式が不正です");
                  return;
                }
                await favPost(shopId);
                alert("お気に入り店舗に登録しました");
                closeLiveScan();
              } catch (e) {
                console.error(e);
                alert("処理に失敗しました");
              }
            },
            {
              preferredCamera: "environment",
              highlightScanRegion: true,
              highlightCodeOutline: true,
            }
          );
          await liveScanner.start();
        } catch (e) {
          console.error(e);
          const go = confirm(
            "カメラを起動できませんでした。画像から読み取りますか？"
          );
          if (go) scanByImage();
          closeLiveScan();
        }
      }
      async function closeLiveScan() {
        const box = document.getElementById("liveScan");
        box?.classList.remove("show");
        document.body.classList.remove("live-scan-open");
        if (liveScanner) {
          try {
            await liveScanner.stop();
          } catch {}
          liveScanner.destroy();
          liveScanner = null;
        }
      }

      async function loadMyReservations() {
        myActive.clear();
        try {
          if (!(typeof liff !== "undefined" && liff.getIDToken)) return;
          const idToken = liff.getIDToken();
          if (!idToken) return; // まだログイン確定前
          const r = await fetch(CONFIG.API_BASE + "/api/my-reservations", {
            headers: { Authorization: "Bearer " + idToken },
          });
          if (r.status === 401) {
            console.warn("my-reservations unauthorized (skip)");
            return;
          }
          const j = await r.json().catch(() => null);
          if (r.ok && j?.ok && Array.isArray(j.items)) {
            j.items.forEach((x) => {
              myActive.set(x.offer_id, {
                id: x.id,
                status: x.status,
                pickup_code: x.pickup_code || null,
              });
            });
          }
        } catch (e) {
          console.warn("loadMyReservations failed", e);
        }
      }

      // ===== お気に入り一覧（右にハートで解除/登録。解除後はその場に残す） =====
      async function getFavoriteShopIds() {
        const userKey = await getUserKey();
        return [...readFavSetSync(userKey)];
      }

      // __lastOffers から shop情報を拾う（なければ最小限の形を返す）
      function findShopFromOffers(shopId) {
        const all = window.__lastOffers || [];
        for (const of of all) {
          const s = of.shop || of.shops;
          if (!s) continue;
          const sid = String(s.id ?? s.shop_id ?? "");
          if (sid === String(shopId)) return s;
        }
        return { id: shopId, name: "店舗" };
      }

      function favCardSVG() {
        return `
  <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
    <path d="m12 21-1.45-1.32C6 15.36 3 12.61 3 9.28 3 6.5 5.24 4.5 7.88 4.5c1.45 0 2.87.64 3.78 1.67A5.2 5.2 0 0 1 15.44 4.5C18.08 4.5 20.3 6.5 20.3 9.28c0 3.33-3 6.08-7.55 10.4L12 21Z"
      fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
  </svg>`;
      }

      function createFavCard(shop, isFav) {
        const sid = String(shop?.id ?? shop?.shop_id ?? "");
        const card = document.createElement("article");
        card.className = "card";
        card.dataset.shopId = sid;

        const title = shop?.name || "店舗";
        const sub = shop?.station || shop?.address || "";

        card.innerHTML = `
    <div class="row">
      <div style="min-width:0">
        <div class="name" style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${title}</div>
        <div class="muted" style="font-size:12px">${sub}</div>
      </div>
      <button class="heart" aria-label="お気に入り">${favCardSVG()}</button>
    </div>
    <div class="btn-row" style="margin-top:8px">
      <button class="primary open-shop">店舗ページへ</button>
    </div>
    <div class="muted removed-msg" style="display:none;margin-top:6px;">解除しました（このページを離れると消えます）</div>
  `;

        const btn = card.querySelector(".heart");
        applyFavUI(btn, !!isFav);

        // 店舗ページへ
        card.querySelector(".open-shop").onclick = () => {
          if (sid) openShopPage(sid, null);
        };

        // ハートのトグル（解除してもDOMからは消さない）
        btn.onclick = async () => {
          // 二重押し防止
          if (btn.dataset.busy === "1") return;
          btn.dataset.busy = "1";

          const userKey = await getUserKey();
          const set = readFavSetSync(userKey);
          const nowFav = set.has(sid);
          const willFav = !nowFav;

          // 先にローカルを確定
          if (willFav) set.add(sid);
          else set.delete(sid);
          writeFavSetSync(userKey, set);
          applyFavUI(btn, willFav);

          // サーバ同期（失敗してもDOMは残す）
          try {
            const r = willFav
              ? await favoriteAdd(sid)
              : await favoriteRemove(sid);
            // 未対応は黙ってローカル優先
            if (!r?.ok && !r?.unsupported) {
              // 真の失敗はロールバック
              if (willFav) set.delete(sid);
              else set.add(sid);
              writeFavSetSync(userKey, set);
              applyFavUI(btn, !willFav);
              alert("同期に失敗しました。電波状態をご確認ください。");
            } else {
              // 解除した場合は表示だけ残す
              if (!willFav) {
                const msg = card.querySelector(".removed-msg");
                if (msg) msg.style.display = "block";
                card.style.opacity = "0.7";
              } else {
                // 再登録したら元に戻す
                const msg = card.querySelector(".removed-msg");
                if (msg) msg.style.display = "none";
                card.style.opacity = "";
              }
            }
          } finally {
            btn.dataset.busy = "0";
          }
        };

        return card;
      }

      async function openFavPage() {
        const userKey = await getUserKey();
        g.favSnapshot = readFavSetSync(userKey); // 入室時の集合を固定
        renderFavoritesPage();
      }

      async function renderFavoritesPage() {
        const wrap = document.getElementById("fav-list");
        if (!wrap) return; // コンテナが無ければ何もしない
        wrap.innerHTML = "";

        const favIds = Array.from(g.favSnapshot || []);
        if (!favIds.length) {
          wrap.innerHTML = '<p class="muted">お気に入りはありません</p>';
          return;
        }

        for (const sid of favIds) {
          // 既存データのヒント → 無ければ API で取得
          let shop = (window.__lastOffers || [])
            .map((o) => o.shop || o.shops)
            .find((s) => String(s?.id) === String(sid));
          if (!shop) {
            try {
              shop = await fetchShopDetail(sid);
            } catch {}
          }

          const name = shop?.name || "店舗";
          const addr = shop?.address || "";

          const card = document.createElement("article");
          card.className = "card fav-card";
          card.innerHTML = `
      <div class="row">
        <div style="min-width:0">
          <div class="name" style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${name}</div>
          <div class="muted" style="font-size:12px">${addr}</div>
          <div class="muted fav-msg" style="font-size:12px"></div>
        </div>
        <button class="heart active" aria-label="お気に入り" data-sid="${sid}">
          <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
            <path d="m12 21-1.45-1.32C6 15.36 3 12.61 3 9.28 3 6.5 5.24 4.5 7.88 4.5c1.45 0 2.87.64 3.78 1.67A5.2 5.2 0 0 1 15.44 4.5C18.08 4.5 20.3 6.5 20.3 9.28c0 3.33-3 6.08-7.55 10.4L12 21Z"
                fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>`;

          // カードタップで店舗ページへ
          card.addEventListener("click", (ev) => {
            if (ev.target.closest(".heart")) return;
            openShopPage(sid);
          });

          // ★ ハートのトグル（解除してもカードは消さない）
          const btn = card.querySelector(".heart");
          btn.onclick = async () => {
            const userKey = await getUserKey();
            const favSet = readFavSetSync(userKey);

            const nowFav = favSet.has(sid);
            const willFav = !nowFav;

            // ローカル即時反映
            if (willFav) favSet.add(sid);
            else favSet.delete(sid);
            writeFavSetSync(userKey, favSet);
            applyFavUI(btn, willFav);

            // サーバ同期（失敗時はロールバック、未対応は黙認）
            let ok = false,
              unsupported = false;
            try {
              const r = willFav
                ? await favoriteAdd(sid)
                : await favoriteRemove(sid);
              ok = !!r?.ok;
              unsupported =
                !!r?.unsupported || [400, 404, 405].includes(r?.status);
            } catch {}

            if (!ok && !unsupported) {
              // ロールバック
              if (willFav) favSet.delete(sid);
              else favSet.add(sid);
              writeFavSetSync(userKey, favSet);
              applyFavUI(btn, !willFav);
              return;
            }

            // ★ 解除済みは残す（薄く＆メッセージ）
            if (!willFav) {
              card.classList.add("pending-remove");
              const msg = card.querySelector(".fav-msg");
              if (msg)
                msg.textContent =
                  "解除しました。このページを離れると一覧から消えます。";
            }
          };

          wrap.appendChild(card);
        }
      }

      /* ============== イベント登録 ============== */
      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("btn-scan")
          ?.addEventListener("click", openLiveScan);
        document
          .getElementById("scanClose")
          ?.addEventListener("click", closeLiveScan);
        document.getElementById("liveScan")?.addEventListener("click", (e) => {
          if (e.target && e.target.id === "liveScan") closeLiveScan();
        });
        document
          .getElementById("friendCheckBtn")
          ?.addEventListener("click", checkFriendship);

        // ページ切り替え
        function showPage(name) {
          // ページの表示/非表示
          document
            .querySelectorAll(".page")
            .forEach((p) => p.classList.remove("active"));
          if (name === "home")
            document.getElementById("page-home")?.classList.add("active");
          if (name === "discover")
            document.getElementById("page-discover")?.classList.add("active");
          document.body.classList.remove("shop-mode"); // discover では常に解除

          if (name === "shop")
            document.getElementById("page-shop")?.classList.add("active");
          if (name === "fav")
            document.getElementById("page-fav")?.classList.add("active");
          if (name === "fav") {
            document.getElementById("page-fav")?.classList.add("active");
            document.body.classList.remove("shop-mode");
            openFavPage(); // 入室時スナップショットで固定。解除してもカードは残す
          }

          // タブのON/OFF（home / discover のみ）
          document
            .querySelectorAll(".tabbar button")
            .forEach((b) => b.classList.remove("active"));
          if (["home", "discover", "fav"].includes(name)) {
            document
              .querySelector(`.tabbar button[data-page="${name}"]`)
              ?.classList.add("active");
          }

          if (name === "discover") {
            // フルスクリーン化（既存処理）
            document.body.classList.add("discover-full");
            document.getElementById("page-discover")?.classList.add("fullmap");
            document.body.classList.remove("shop-mode"); // ★追加
            // ★ 追加1: 地図が未初期化ならここで必ず初期化
            if (!mapApi) {
              renderMap(window.__lastOffers || []);
            }

            // ★ 追加2: サイズ再計算 → 現在地＋近隣店舗に自動フィット
            setTimeout(() => {
              if (mapApi) {
                mapApi.invalidateSize();
                mapAutoFitDone = false; // 一度は必ずフィットさせる
                fitToUserAndNearest(window.__lastOffers || [], true);
              }
            }, 80);
          } else {
            // discover 以外
            document.body.classList.remove("discover-full");
            document
              .getElementById("page-discover")
              ?.classList.remove("fullmap");

            if (name === "shop") {
              // ★ 店舗ページのときだけ共通UIを隠す
              document.body.classList.add("shop-mode");
              // 店舗ページ内のミニマップサイズ補正
              setTimeout(() => shopMapApi && shopMapApi.invalidateSize(), 80);
            } else {
              // ★ 店舗ページ以外では表示を戻す
              document.body.classList.remove("shop-mode");
            }
          }
          // 店舗ページ以外ではカートバーを隠す
          const cartBarEl = document.getElementById("cart-bar");
          if (cartBarEl) {
            cartBarEl.style.display = name === "shop" ? "flex" : "none";
          }

          if (name === "fav") {
            openFavPage(); // スナップショットで描画（非同期でOK）
          } else {
            g.favSnapshot = null; // 退室時に破棄 → 次回は最新が反映
          }
        }

        // ホーム上部の検索：Enterで「お店を探す」に切り替え
        const qHome = document.getElementById("q-home");
        if (qHome) {
          qHome.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              const v = qHome.value.trim();
              // まずはDiscoverへ切替
              showPage("discover");
              // 検索欄の値も同期（将来ジオコーディングをここで実装）
              const qMap = document.getElementById("q-map");
              if (qMap) qMap.value = v;
              qHome.blur();
            }
          });
        }

        // どこか他の関数の外（showPageの近く）に追加
        function showShopPageNow() {
          // ページの切替
          document
            .querySelectorAll(".page")
            .forEach((p) => p.classList.remove("active"));
          document.getElementById("page-shop")?.classList.add("active");

          // UI状態
          document.body.classList.remove("discover-full");
          document.getElementById("page-discover")?.classList.remove("fullmap");
          document.body.classList.add("shop-mode");

          // 店舗ページの地図をリフレッシュ
          setTimeout(() => shopMapApi && shopMapApi.invalidateSize(), 80);
        }

        // ページ外から呼べるようイベントもフック
        document.addEventListener("app:showPage", (e) =>
          showPage(e.detail?.name)
        );

        document
          .querySelectorAll(".tabbar button[data-page]")
          .forEach((btn) =>
            btn.addEventListener("click", () => showPage(btn.dataset.page))
          );
        document
          .querySelector('button[data-page="fav"]')
          ?.addEventListener("click", () => {
            showPage("fav"); // 表示時に openFavPage() が呼ばれる
          });

        document
          .getElementById("nav-scan")
          ?.addEventListener("click", openLiveScan);
        document
          .getElementById("more-near")
          ?.addEventListener("click", () => showPage("discover"));
        document
          .getElementById("more-recent")
          ?.addEventListener("click", () => showPage("discover"));

        // 検索（ホームの簡易フィルタ）
        const q = document.getElementById("q");
        if (q)
          q.addEventListener("input", () => {
            const kw = q.value.trim().toLowerCase();
            if (!window.__lastOffers) return;
            const base = window.__lastOffers;
            const filtered = kw
              ? base.filter((it) => {
                  const shop = it.shop || it.shops;
                  return (
                    (it.title || "").toLowerCase().includes(kw) ||
                    (shop?.name || "").toLowerCase().includes(kw) ||
                    (shop?.address || "").toLowerCase().includes(kw)
                  );
                })
              : base;
            renderHomeSections(filtered);
          });

        // Discoverの検索（UIだけ、必要ならAPI検索へ繋ぐ）
        const qMap = document.getElementById("q-map");
        if (qMap)
          qMap.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              // TODO: ここで住所→座標検索等に繋ぐ（現状はUIのみ）
              e.target.blur();
            }
          });
        // ハッシュ遷移 (#shop:SHOP_ID) からの表示
        window.addEventListener("hashchange", () => {
          const m = location.hash.match(/^#shop:(.+)$/);
          if (m) {
            const sid = m[1];
            // 既存オファー配列からヒントを探す（なくてもOK）
            const hint =
              (window.__lastOffers || []).find(
                (o) => String(o.shop?.id ?? o.shops?.id) === sid
              ) || null;
            openShopPage(sid, hint);
          } else if (location.hash === "" || location.hash === "#home") {
            showPage("home");
          }
        });
        // 現在地ボタン（コンパス）
        document
          .getElementById("btn-locate")
          ?.addEventListener("click", async () => {
            try {
              const geo = await new Promise((ok, ng) =>
                navigator.geolocation.getCurrentPosition(ok, ng, {
                  enableHighAccuracy: true,
                  timeout: 8000,
                })
              );
              g.pos = { lat: geo.coords.latitude, lng: geo.coords.longitude };
              if (mapApi) {
                mapApi.addUserMarker(g.pos.lat, g.pos.lng);
                mapAutoFitDone = false;
                fitToUserAndNearest(window.__lastOffers || [], true);
              }
            } catch {
              alert(
                "現在地を取得できませんでした。端末の位置情報設定をご確認ください。"
              );
            }

            updateHomeCartBadge();

            // ホーム右上のカートを押したら、店舗ページへ遷移してチェックアウトを開く
            document
              .getElementById("home-cart-btn")
              ?.addEventListener("click", () => {
                const cartEmpty = !g.cart || Object.keys(g.cart).length === 0;

                if (cartEmpty) {
                  alert(
                    "カートに商品がありません。店舗ページで商品を選ぶとカートに入ります。"
                  );
                  return;
                }

                // 店舗ページへ切替 → チェックアウト表示
                document.dispatchEvent(
                  new CustomEvent("app:showPage", { detail: { name: "shop" } })
                );
                setTimeout(
                  () => typeof openCheckout === "function" && openCheckout(),
                  80
                );
              });
          });
        // 解除後もカードを残すための見た目切替
        function markFavCardGhost(card, on) {
          if (!card) return;
          card.classList.toggle("ghost", !!on);
          let note = card.querySelector(".ghost-note");
          if (!note) {
            note = document.createElement("small");
            note.className = "ghost-note";
            note.textContent =
              "お気に入り解除済み（このページを離れると消えます）";
            (card.querySelector(".title") || card).appendChild(note);
          }
          note.style.display = on ? "inline" : "none";
        }
      });

      // ?resetFav=1 で端末のお気に入り（このユーザー分）を一度クリア
      if (new URLSearchParams(location.search).get("resetFav") === "1") {
        getUserKey().then((k) => {
          localStorage.removeItem("mottaina:fav:" + k);
          alert("端末のお気に入りをクリアしました");
        });
      }

      // 起動
      init();

      // レイアウト調整
      function updateTabbarInset() {
        const tb = document.querySelector(".tabbar");
        if (!tb) return;
        const h = Math.ceil(tb.getBoundingClientRect().height);
        document.documentElement.style.setProperty("--tabbar-h", h + "px");
      }
      window.addEventListener("load", updateTabbarInset);
      window.addEventListener("resize", updateTabbarInset);
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) updateTabbarInset();
      });
      if (window.ResizeObserver) {
        const tb = document.querySelector(".tabbar");
        if (tb) new ResizeObserver(updateTabbarInset).observe(tb);
      }

      // 地図サイズ再計算
      let _resizeTimer;
      function fixMapSize(recenter = false) {
        if (!mapApi) return;
        clearTimeout(_resizeTimer);
        _resizeTimer = setTimeout(() => {
          mapApi.invalidateSize();
          if (recenter) {
            mapAutoFitDone = false;
            fitToUserAndNearest(window.__lastOffers || [], true);
          }
        }, 80);
      }
      window.addEventListener("load", () => fixMapSize(false));
      window.addEventListener("resize", () => fixMapSize(false));
      window.addEventListener(
        "resize",
        () => shopMapApi && shopMapApi.invalidateSize()
      );
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) fixMapSize(false);
      });
      // 店舗ページのミニマップも保険で再計測
      window.addEventListener("resize", scheduleShopMapFix);
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) scheduleShopMapFix();
      });
      async function renderFavorites() {
        const userKey = await getUserKey();
        const favSet = readFavSetSync(userKey);
        const ids = [...favSet];
        const el = document.getElementById("fav-list");
        if (!el) return;
        if (ids.length === 0) {
          el.innerHTML = '<p class="muted">お気に入りはありません。</p>';
          return;
        }

        const byId = {};
        (window.__lastOffers || []).forEach((o) => {
          const s = o.shop || o.shops;
          if (s?.id) byId[String(s.id)] = s;
        });

        const shops = [];
        for (const sid of ids) {
          if (byId[sid]) {
            shops.push(byId[sid]);
            continue;
          }
          try {
            const r = await fetch(
              `${CONFIG.SUPABASE_URL}/rest/v1/shops?id=eq.${encodeURIComponent(
                sid
              )}&select=id,name,address,photo_url`,
              {
                headers: {
                  apikey: CONFIG.SUPABASE_ANON_KEY,
                  Authorization: "Bearer " + CONFIG.SUPABASE_ANON_KEY,
                },
              }
            );
            if (r.ok) {
              const j = await r.json();
              if (j[0]) shops.push(j[0]);
            }
          } catch {}
        }

        el.innerHTML = shops
          .map(
            (s) => `
    <div class="fav-card" data-shop="${s.id}">
      <img src="${
        s.photo_url ||
        `https://placehold.co/160x160/j5b09d/fff?text=${encodeURIComponent(
          s.name || "Shop"
        )}`
      }" alt="">
      <div class="info">
        <div class="name">${s.name || "店舗"}</div>
        <div class="meta">${s.address || ""}</div>
      </div>
    </div>`
          )
          .join("");

        el.querySelectorAll(".fav-card").forEach((card) => {
          card.addEventListener("click", () => {
            const sid = card.getAttribute("data-shop");
            const hint =
              (window.__lastOffers || []).find(
                (o) => String(o.shop?.id ?? o.shops?.id) === String(sid)
              ) || null;
            openShopPage(sid, hint);
          });
        });
      }
    </script>
  </body>
</html>
