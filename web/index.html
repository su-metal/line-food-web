<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>line-food-web</title>
    <link rel="icon" href="./favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="./css/app.css?v=20250909b" />
  </head>
  <body>
    <!-- ヘッダ -->
    <header class="app-header">
      <div class="search-wrap">
        <svg aria-hidden="true" viewBox="0 0 24 24">
          <path
            d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"
          />
        </svg>
        <input type="search" placeholder="現在地・駅・店舗名などから探す" />
      </div>
      <button class="icon-btn" aria-label="通知">
        <svg viewBox="0 0 24 24">
          <path d="M10 21a2 2 0 0 0 4 0M5 8a7 7 0 1 1 14 0v5l2 3H3l2-3V8Z" />
        </svg>
      </button>
    </header>

    <!-- カテゴリー（横スクロール） -->
    <div class="cat-row" id="category-row">
      <button type="button" class="cat-item" data-cat="パン">
        <img
          src="./img/categories/bread.png"
          alt="パン"
          width="48"
          height="48"
          loading="lazy"
        />
        <span>パン</span>
      </button>

      <button type="button" class="cat-item" data-cat="ケーキ">
        <img
          src="./img/categories/cake.png"
          alt="ケーキ"
          width="48"
          height="48"
          loading="lazy"
        />
        <span>ケーキ</span>
      </button>

      <button type="button" class="cat-item" data-cat="お惣菜">
        <img
          src="./img/categories/deli.png"
          alt="お惣菜"
          width="48"
          height="48"
          loading="lazy"
        />
        <span>お惣菜</span>
      </button>

      <button type="button" class="cat-item" data-cat="お弁当">
        <img
          src="./img/categories/bento.png"
          alt="お弁当"
          width="48"
          height="48"
          loading="lazy"
        />
        <span>お弁当</span>
      </button>

      <button type="button" class="cat-item" data-cat="その他">
        <img
          src="./img/categories/others.png"
          alt="その他"
          width="48"
          height="48"
          loading="lazy"
        />
        <span>その他</span>
      </button>
    </div>

    <!-- 価格帯（横スクロールのタグ） -->
    <section class="price">
      <div class="chip-row" role="group" aria-label="価格帯から選ぶ">
        <button class="chip" data-price="<=300" aria-pressed="false">
          300円以下
        </button>
        <button class="chip" data-price="<=500" aria-pressed="false">
          500円以下
        </button>
        <button class="chip" data-price="<=1000" aria-pressed="false">
          1000円以下
        </button>
        <button class="chip" data-price="<=1500" aria-pressed="false">
          1500円以下
        </button>
      </div>
    </section>

    <main class="container">
      <!-- ===== Home Hero ===== -->
      <section class="home-hero">
        <div class="hero-inner">
          <a id="hero-card-main" href="#" class="hero-card">
            <!-- 初期は存在する画像にして404回避。JSで差し替え -->
            <img
              id="hero-img-main"
              src="./img/noimg.svg"
              alt="本日のおすすめ"
              loading="lazy"
            />
            <div class="hero-caption">
              <h2 id="hero-title">HELLO!</h2>
              <p id="hero-sub">本日のおすすめ</p>
            </div>
          </a>

          <div class="hero-grid">
            <a id="hero-card-s1" href="#" class="hero-card small">
              <img
                id="hero-s1-img"
                src="./img/noimg.svg"
                alt="特集"
                loading="lazy"
              />
              <div class="hero-caption small" id="hero-s1-cap">
                YAP! ARCHIVES
              </div>
            </a>
            <a id="hero-card-s2" href="#" class="hero-card small">
              <img
                id="hero-s2-img"
                src="./img/noimg.svg"
                alt="サステナブル"
                loading="lazy"
              />
              <div class="hero-caption small" id="hero-s2-cap">OUR CHANGE</div>
            </a>
          </div>
        </div>
      </section>
      <!-- ===== /Home Hero ===== -->

      <div class="quick">…（省略）…</div>

      <!-- 近くのお店 -->
      <div class="section-head">
        <h3>現在地付近のお店</h3>
        <a class="more" href="#">もっと見る</a>
      </div>
      <div class="card-row" id="nearby-row"></div>

      <!-- 最近追加 -->
      <div class="section-head">
        <h3>最近追加されたお店</h3>
        <a class="more" href="#">もっと見る</a>
      </div>
      <div class="card-row" id="recent-row"></div>

      <!-- テンプレート -->
      <template id="shop-card-template"> …（省略）… </template>
    </main>

    <!-- ⭐ カート（固定・中央寄せ） -->
    <button
      type="button"
      class="home-cta cart-cta"
      id="cart-bar"
      aria-live="polite"
    >
      <svg class="cart-ico" viewBox="0 0 24 24" aria-hidden="true">
        <path
          d="M7 6h13l-1.6 8.3a2 2 0 0 1-2 1.7H9.2a2 2 0 0 1-2-1.6L5.3 4H3"
        ></path>
      </svg>
      <span class="cart-text"
        ><strong>カート</strong>
        <span id="cart-summary">カートは空です</span></span
      >
    </button>
    <!-- CTAの下に少しだけ余白を確保（固定表示でコンテンツが隠れないように） -->
    <div class="cart-spacer" aria-hidden="true"></div>

    <!-- 下部タブ -->
    <nav class="tabbar" aria-label="メイン">
      <a class="active" href="#">
        <span class="icon" aria-hidden="true">
          <!-- home/store -->
          <svg viewBox="0 0 24 24">
            <path
              d="M4 10v10h16V10M2 11l10-7 10 7"
              fill="none"
              stroke="currentColor"
              stroke-width="1.8"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </span>
        <span class="label">ホーム</span>
      </a>
      <a href="#">
        <span class="icon" aria-hidden="true">
          <!-- search -->
          <svg viewBox="0 0 24 24">
            <circle
              cx="11"
              cy="11"
              r="6"
              fill="none"
              stroke="currentColor"
              stroke-width="1.8"
            />
            <path
              d="M20 20l-3.8-3.8"
              fill="none"
              stroke="currentColor"
              stroke-width="1.8"
              stroke-linecap="round"
            />
          </svg>
        </span>
        <span class="label">お店を探す</span>
      </a>
      <a href="#">
        <span class="icon" aria-hidden="true">
          <!-- heart -->
          <svg viewBox="0 0 24 24">
            <path
              d="M12 21s-6.7-4.2-9.2-8C1.2 10 2.1 7.2 4.6 6c1.9-1 4.3-.5 5.6 1.2C11.5 5.5 13.9 5 15.8 6c2.5 1.2 3.4 4 1.8 7-2.5 3.8-9.6 8-9.6 8Z"
              fill="none"
              stroke="currentColor"
              stroke-width="1.8"
            />
          </svg>
        </span>
        <span class="label">お気に入り</span>
      </a>
      <a href="#">
        <span class="icon" aria-hidden="true">
          <!-- lifebuoy -->
          <svg viewBox="0 0 24 24">
            <circle
              cx="12"
              cy="12"
              r="9"
              fill="none"
              stroke="currentColor"
              stroke-width="1.8"
            />
            <circle
              cx="12"
              cy="12"
              r="4"
              fill="none"
              stroke="currentColor"
              stroke-width="1.8"
            />
            <path
              d="M5.6 5.6l2.2 2.2M16.2 5.6l2.2 2.2M5.6 16.2l2.2 2.2M16.2 16.2l2.2 2.2"
              fill="none"
              stroke="currentColor"
              stroke-width="1.8"
              stroke-linecap="round"
            />
          </svg>
        </span>
        <span class="label">レスキュー</span>
      </a>
      <a href="#">
        <span class="icon" aria-hidden="true">
          <!-- user -->
          <svg viewBox="0 0 24 24">
            <circle
              cx="12"
              cy="8"
              r="3.2"
              fill="none"
              stroke="currentColor"
              stroke-width="1.8"
            />
            <path
              d="M5 19a7 7 0 0 1 14 0"
              fill="none"
              stroke="currentColor"
              stroke-width="1.8"
              stroke-linecap="round"
            />
          </svg>
        </span>
        <span class="label">マイページ</span>
      </a>
    </nav>

    <!-- （デバッグ要素：既存 app.js が参照するので非表示で残す） -->
    <button id="btnWho" hidden>/api/whoami を呼ぶ</button>
    <pre id="out" hidden></pre>

    <!-- LIFF SDK & 既存モジュール -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script type="module" src="./js/app.js"></script>

    <!-- ヒーロー（ランダム差し替え） -->
    <script type="module" src="./js/hero.js"></script>
    <script type="module" src="./js/home-hero.js"></script>

    <!-- ★ ここに“1つだけ”集約（loadNearby 未定義の解消 & 各UIイベント） -->
    <script type="module">
      const bust = "v20250910a";

      // 必要モジュールを読み込み
      import { loadNearby } from "./js/nearby.js?v=20250909c";
      import { loadRecent } from "./js/recent.js?v=20250909c";
      import { initHomeCartCTA } from "./js/cart-cta.js?v=20250909c";

      // fav.js は LIFF が ready になってから
      let initAllFavButtons = null;
      try {
        const fav = await import("./js/fav.js?" + bust).catch(() => ({}));
        initAllFavButtons = fav.initAllFavButtons || null;
      } catch {}

      // バナー×（あれば）
      document.querySelector(".banner-close")?.addEventListener("click", () => {
        document.querySelector(".banner")?.remove();
      });

      // カテゴリー：#category-row 配下の .cat-item を単一選択
      const catRow = document.getElementById("category-row");
      const activateCat = (btn) => {
        catRow?.querySelectorAll(".cat-item.is-active").forEach((b) => {
          b.classList.remove("is-active");
          b.setAttribute("aria-pressed", "false");
        });
        btn.classList.add("is-active");
        btn.setAttribute("aria-pressed", "true");
      };
      catRow?.addEventListener("click", (e) => {
        const btn = e.target.closest(".cat-item");
        if (!btn) return;
        activateCat(btn);
        refreshLists();
      });

      // 価格帯チップ：単一選択（再クリックで解除）
      const priceRow = document.querySelector(".chip-row");
      priceRow?.addEventListener("click", (e) => {
        const chip = e.target.closest(".chip");
        if (!chip) return;

        const isActive = chip.classList.contains("is-active");
        priceRow.querySelectorAll(".chip").forEach((c) => {
          c.classList.remove("is-active");
          c.setAttribute("aria-pressed", "false");
        });

        if (!isActive) {
          chip.classList.add("is-active");
          chip.setAttribute("aria-pressed", "true");
        }
        refreshLists();
      });

      // クイックソート（近い / 安い / 終了間近）
      let sortMode = localStorage.getItem("sortMode") || "near";
      const seg = document.querySelector(".seg-row");
      const setSortUI = () => {
        seg?.querySelectorAll(".seg-btn").forEach((b) => {
          const on = b.dataset.sort === sortMode;
          b.classList.toggle("is-active", on);
          b.setAttribute("aria-selected", on ? "true" : "false");
        });
      };
      setSortUI();
      seg?.addEventListener("click", (e) => {
        const btn = e.target.closest(".seg-btn");
        if (!btn) return;
        sortMode = btn.dataset.sort || "near";
        localStorage.setItem("sortMode", sortMode);
        setSortUI();
        refreshLists();
      });

      // フィルタ取得
      const getFilters = () => {
        const cat =
          document.querySelector(".cat-item.is-active")?.dataset.cat || null;
        const priceData =
          document.querySelector(".chip.is-active")?.dataset.price || null; // "<=500"
        const priceMax = priceData ? Number(priceData.replace("<=", "")) : null;
        return { category: cat, priceMax, sort: sortMode };
      };

      // 一括再読込
      async function refreshLists() {
        const f = getFilters();
        await Promise.all([loadNearby(f), loadRecent(f)]);
        try {
          await liff.ready;
          initAllFavButtons?.();
        } catch {}
      }

      // 初期ロード
      refreshLists();

      // カートCTA初期化（IDは #cart-bar に合わせる）
      try {
        initHomeCartCTA?.({
          buttonSelector: "#cart-bar",
          countSelector: "#home-cart-count",
          totalSelector: "#home-cart-total",
          cartHref: "./cart.html",
        });
      } catch {}
    </script>
  </body>
</html>
